
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       SE—Standard Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user network, expiring 23 Oct 2026
Serial number: 401909300710
  Licensed to: Daniel Sacks
               

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do /Users/sacks/Projects/VaccSideEffects/code/balance_table.do 

. /*===========================================================================
> ===
>     Balance Table for Main Survey Sample
> 
>     Input:  derived/merged_main_pre.dta
>     Output: output/tables/balance_table.csv
>             output/tables/balance_table.tex (table body only, no headers/meta
> data)
> 
>     Creates balance table with treatment arm means and joint equality tests.
>     Each row is a variable, each column is a treatment arm + p-value.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "balance_table"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory based on operating system
. * c(os) returns "Windows" on Windows, "Unix" or "MacOSX" on Mac
. local usr `c(username)'

. if "`c(os)'" == "Windows" {
.     global projdir "C:/Users/`usr'/Box/VaccSideEffects"
. }

. else {
.     * macOS (Unix or MacOSX)
.     global projdir "/Users/`usr'/Library/CloudStorage/Box-Box/VaccSideEffects
> "
. }

. cd "$projdir"
/Users/sacks/Library/CloudStorage/Box-Box/VaccSideEffects

. 
. * Add local ado files to path (for plot_to_csv and other custom programs)
. adopath + "$projdir/code/include"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Library/CloudStorage/Box-Box/VaccSideEffects/c
> ode/include"

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. /*---------------------------------------------------------------------------
> ---
>     Named Constants
> 
>     These replace magic numbers scattered throughout the codebase.
> -----------------------------------------------------------------------------
> -*/
. 
. * Attention check expected values (from survey design)
. global ATTN_CHECK_PRESCREEN = 1965

. global ATTN_CHECK_MAIN = 4419

. global ATTN_CHECK_FOLLOWUP = 1163

. 
. * Special code for "Prefer not to say" responses
. global PREF_NOT_SAY = -99

. 
. /*---------------------------------------------------------------------------
> ---
>     Conditional Logging
> -----------------------------------------------------------------------------
> -*/
. 
. * Only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/sacks/Library/CloudStorage/Box-Box/VaccSideEffects/output/l
> ogs/balance_table.log
  log type:  text
 opened on:  21 Jan 2026, 21:24:01
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: balance_table ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/balance_table.log
.     di ""

. }

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     1. Load merged data
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/merged_main_pre.dta", clear

. count
  3,538

. di "Total merged observations: " r(N)
Total merged observations: 3538

. 
. /*---------------------------------------------------------------------------
> ---
>     2. Create indicator variables for balance table
> -----------------------------------------------------------------------------
> -*/
. 
. * Prior belief: somewhat likely or more likely to experience SE with vaccine 
> (>=5)
. gen prior_vacc_likely = (prior_self_vacc >= 5) if ~missing(prior_self_vacc)

. label var prior_vacc_likely "Prior: SE likely with vaccine"

. 
. * Do not intend to vaccinate (from prescreen, vacc_intent == 1)
. gen pre_no_intent = (pre_vacc_intent_pre == 1) if ~missing(pre_vacc_intent_pr
> e)
(13 missing values generated)

. label var pre_no_intent "Do not intend to vaccinate"

. 
. * Previously had flu vaccine
. gen pre_had_flu = had_prior_flu_vacc
(13 missing values generated)

. label var pre_had_flu "Previously had flu vaccine"

. 
. * Previously had COVID vaccine
. gen pre_had_covid = had_prior_covid_vacc
(13 missing values generated)

. label var pre_had_covid "Previously had COVID vaccine"

. 
. * Severe flu vaccine reaction (conditional on having had flu vacc)
. gen severe_flu_reaction = (flu_vacc_reaction == 3) if had_prior_flu_vacc == 1
(1,444 missing values generated)

. label var severe_flu_reaction "Severe flu vaccine reaction"

. 
. * Severe COVID vaccine reaction (conditional on having had COVID vacc)
. gen severe_covid_reaction = (covid_vacc_reaction == 3) if had_prior_covid_vac
> c == 1
(1,312 missing values generated)

. label var severe_covid_reaction "Severe COVID vaccine reaction"

. 
. * Has health condition (cond_none == 0, conditional on not missing)
. gen has_condition = (cond_none == 0) if ~missing(cond_none)
(13 missing values generated)

. label var has_condition "Has health condition"

. 
. * Age, race, ethnicity variables already created in clean_main.do
. * Use existing variables from merged dataset (capture gen in case they don't 
> exist)
. capture gen age_18_34 = (age == 2) if ~missing(age) & age != $PREF_NOT_SAY

. capture label var age_18_34 "Age 18--34"

. 
. capture gen age_35_49 = (age == 3) if ~missing(age) & age != $PREF_NOT_SAY

. capture label var age_35_49 "Age 35--49"

. 
. capture gen race_white = (race == 1) if ~missing(race) & race != 7

. capture label var race_white "White"

. 
. capture gen hispanic = (ethnicity == 1) if ~missing(ethnicity) & ethnicity !=
>  3

. capture label var hispanic "Hispanic"

. 
. * Income < 50k (income == 1 or 2)
. * Exclude 6 = "Prefer not to say"
. gen income_lt50k = (income <= 2) if ~missing(income) & income != 6
(95 missing values generated)

. label var income_lt50k "Income under 50k"

. 
. * Trust government somewhat or strongly (trust_govt >= 4)
. gen trust_govt_high = (trust_govt >= 4) if ~missing(trust_govt)
(13 missing values generated)

. label var trust_govt_high "Trust government"

. 
. * Follow doctor somewhat or strongly (follow_doctor >= 4)
. gen follow_doc_high = (follow_doctor >= 4) if ~missing(follow_doctor)
(13 missing values generated)

. label var follow_doc_high "Follow doctor advice"

. 
. * College degree (education == 4 or 5)
. * Exclude 6 = "Prefer not to say"
. gen college = (education == 4 | education == 5) if ~missing(education) & educ
> ation != 6
(21 missing values generated)

. label var college "College degree"

. 
. /*---------------------------------------------------------------------------
> ---
>     3. Define variable list for balance table
> -----------------------------------------------------------------------------
> -*/
. 
. local balance_vars ///
>     prior_vacc_likely ///
>     pre_no_intent ///
>     pre_had_flu ///
>     pre_had_covid ///
>     severe_flu_reaction ///
>     severe_covid_reaction ///
>     has_condition ///
>     age_18_34 ///
>     age_35_49 ///
>     race_white ///
>     hispanic ///
>     income_lt50k ///
>     trust_govt_high ///
>     follow_doc_high ///
>     college

. 
. /*---------------------------------------------------------------------------
> ---
>     4. Calculate sample sizes by arm
> -----------------------------------------------------------------------------
> -*/
. 
. * Get sample sizes for each arm (using a variable with no missings for full s
> ample)
. count if arm_n == 0
  885

. local N0 = r(N)

. count if arm_n == 1
  885

. local N1 = r(N)

. count if arm_n == 2
  882

. local N2 = r(N)

. count if arm_n == 3
  886

. local N3 = r(N)

. local N_total = `N0' + `N1' + `N2' + `N3'

. 
. di "Sample sizes: Control=`N0' Industry=`N1' Academic=`N2' Personal=`N3' Tota
> l=`N_total'"
Sample sizes: Control=885 Industry=885 Academic=882 Personal=886 Total=3538

. 
. /*---------------------------------------------------------------------------
> ---
>     5. Program to calculate balance stats for a variable
> -----------------------------------------------------------------------------
> -*/
. 
. capture program drop calc_balance_stats

. program define calc_balance_stats, rclass
  1.     syntax varname
  2. 
.     * Get means by arm
.     quietly {
  3.         sum `varlist' if arm_n == 0
  4.         local mean0 = r(mean)
  5. 
.         sum `varlist' if arm_n == 1
  6.         local mean1 = r(mean)
  7. 
.         sum `varlist' if arm_n == 2
  8.         local mean2 = r(mean)
  9. 
.         sum `varlist' if arm_n == 3
 10.         local mean3 = r(mean)
 11.     }
 12. 
.     * Test joint equality (F-test from regression with robust SEs)
.     quietly regress `varlist' i.arm_n, vce(robust)
 13.     quietly testparm i.arm_n
 14.     local pval = r(p)
 15. 
.     * Return results
.     return scalar mean0 = `mean0'
 16.     return scalar mean1 = `mean1'
 17.     return scalar mean2 = `mean2'
 18.     return scalar mean3 = `mean3'
 19.     return scalar pval = `pval'
 20. end

. 
. /*---------------------------------------------------------------------------
> ---
>     6. Calculate means by treatment arm and p-values
> -----------------------------------------------------------------------------
> -*/
. 
. * Open output files
. capture file close csvout

. capture file close texout

. file open csvout using "output/tables/balance_table.csv", write replace

. file open texout using "output/tables/balance_table.tex", write replace

. 
. * Write CSV header
. file write csvout "Variable,Control,Industry,Academic,Personal,P-value" _n

. 
. foreach var of local balance_vars {
  2.     * Get variable label for display
.     local varlabel: variable label `var'
  3.     if "`varlabel'" == "" local varlabel "`var'"
  4. 
.     * Calculate stats
.     calc_balance_stats `var'
  5. 
.     * Format means (3 decimal places)
.     local mean0_fmt: di %6.3f r(mean0)
  6.     local mean1_fmt: di %6.3f r(mean1)
  7.     local mean2_fmt: di %6.3f r(mean2)
  8.     local mean3_fmt: di %6.3f r(mean3)
  9.     local pval_fmt: di %6.3f r(pval)
 10. 
.     * Write to CSV
.     file write csvout "`varlabel',`mean0_fmt',`mean1_fmt',`mean2_fmt',`mean3_
> fmt',`pval_fmt'" _n
 11. 
.     * Write to LaTeX
.     file write texout "`varlabel' & `mean0_fmt' & `mean1_fmt' & `mean2_fmt' &
>  `mean3_fmt' & `pval_fmt' \\" _n
 12. 
.     di "`varlabel': Control=`mean0_fmt' Industry=`mean1_fmt' Academic=`mean2_
> fmt' Personal=`mean3_fmt' p=`pval_fmt'"
 13. }
Prior: SE likely with vaccine: Control= 0.551 Industry= 0.541 Academic= 0.533 P
> ersonal= 0.529 p= 0.794
Do not intend to vaccinate: Control= 0.655 Industry= 0.666 Academic= 0.674 Pers
> onal= 0.662 p= 0.870
Previously had flu vaccine: Control= 0.600 Industry= 0.624 Academic= 0.560 Pers
> onal= 0.592 p= 0.055
Previously had COVID vaccine: Control= 0.627 Industry= 0.642 Academic= 0.625 Pe
> rsonal= 0.632 p= 0.876
Severe flu vaccine reaction: Control= 0.108 Industry= 0.093 Academic= 0.089 Per
> sonal= 0.105 p= 0.703
Severe COVID vaccine reaction: Control= 0.170 Industry= 0.144 Academic= 0.135 P
> ersonal= 0.168 p= 0.256
Has health condition: Control= 0.169 Industry= 0.218 Academic= 0.168 Personal= 
> 0.182 p= 0.033
Age 18--34: Control= 0.351 Industry= 0.343 Academic= 0.333 Personal= 0.322 p= 0
> .588
Age 35--49: Control= 0.400 Industry= 0.386 Academic= 0.420 Personal= 0.389 p= 0
> .444
White: Control= 0.756 Industry= 0.750 Academic= 0.745 Personal= 0.755 p= 0.944
Hispanic: Control= 0.080 Industry= 0.095 Academic= 0.099 Personal= 0.091 p= 0.5
> 47
Income under 50k: Control= 0.350 Industry= 0.399 Academic= 0.382 Personal= 0.35
> 9 p= 0.146
Trust government: Control= 0.471 Industry= 0.451 Academic= 0.453 Personal= 0.44
> 7 p= 0.773
Follow doctor advice: Control= 0.568 Industry= 0.550 Academic= 0.548 Personal= 
> 0.566 p= 0.755
College degree: Control= 0.535 Industry= 0.505 Academic= 0.495 Personal= 0.519 
> p= 0.363

. 
. /*---------------------------------------------------------------------------
> ---
>     7. Joint F-test for all variables (SUR approach)
> -----------------------------------------------------------------------------
> -*/
. 
. di ""


. di "=== JOINT BALANCE TEST ==="
=== JOINT BALANCE TEST ===

. 
. * Use seemingly unrelated regression for joint test
. quietly {

. 
. di "Joint chi-squared(`joint_df') = " %8.3f `joint_chi2'
Joint chi-squared(45) =   42.508

. di "Joint p-value = " %6.3f `joint_p'
Joint p-value =  0.578

. 
. /*---------------------------------------------------------------------------
> ---
>     8. Write joint test and sample sizes to output files
> -----------------------------------------------------------------------------
> -*/
. 
. * Format joint test results
. local joint_chi2_fmt: di %8.3f `joint_chi2'

. local joint_p_fmt: di %6.3f `joint_p'

. 
. * Append to CSV
. file write csvout _n

. file write csvout "Joint test,chi2(`joint_df')=`joint_chi2_fmt',,,`joint_p_fm
> t'" _n

. file write csvout _n

. file write csvout "N,`N0',`N1',`N2',`N3'," _n

. 
. * Append to LaTeX
. file write texout "\addlinespace" _n

. local joint_chi2_tex: di %5.3f `joint_chi2'

. local joint_p_tex: di %5.3f `joint_p'

. file write texout "Joint test & \multicolumn{4}{c}{\$\chi^2(`joint_df')=`join
> t_chi2_tex'\$} & `joint_p_tex' \\" _n

. file write texout "\addlinespace" _n

. file write texout "N & `N0' & `N1' & `N2' & `N3' &" _n

. 
. file close csvout

. file close texout

. 
. di ""


. di "=== BALANCE TABLE COMPLETE ==="
=== BALANCE TABLE COMPLETE ===

. di "Saved: output/tables/balance_table.csv"
Saved: output/tables/balance_table.csv

. di "Saved: output/tables/balance_table.tex"
Saved: output/tables/balance_table.tex

. 
. capture log close

. 
end of do-file


  ___  ____  ____  ____  ____ ©
 /__    /   ____/   /   ____/      17.0
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2021 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-STATA-PC        https://www.stata.com
                                   979-696-4600        stata@stata.com

Stata license: Single-user 4-core  perpetual
Serial number: 501709220187
  Licensed to: Dan Sacks
               Indiana University

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000; see help set_maxvar.

. do code/balance_table.do 

. /*===========================================================================
> ===
>     Balance Table for Main Survey Sample
> 
>     Input:  derived/merged_main_pre.dta
>     Output: output/tables/balance_table.csv
>             output/tables/balance_table.tex (table body only, no headers/meta
> data)
> 
>     Creates balance table with treatment arm means and joint equality tests.
>     Each row is a variable, each column is a treatment arm + p-value.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "balance_table"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory
. local usr `c(username)'

. global projdir "C:/Users/`usr'/Box/VaccSideEffects"

. cd "$projdir"
C:\Users\sacks\Box\VaccSideEffects

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. * Conditional logging: only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\sacks\Box\VaccSideEffects\output/logs/balance_table.log
  log type:  text
 opened on:  18 Jan 2026, 10:27:21
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: balance_table ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/balance_table.log
.     di ""

. }

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     1. Load merged data
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/merged_main_pre.dta", clear

. count
  3,538

. di "Total merged observations: " r(N)
Total merged observations: 3538

. 
. /*---------------------------------------------------------------------------
> ---
>     2. Create indicator variables for balance table
> -----------------------------------------------------------------------------
> -*/
. 
. * Prior belief: somewhat likely or more likely to experience SE with vaccine 
> (>=5)
. gen prior_vacc_likely = (prior_self_vacc >= 5) if ~missing(prior_self_vacc)

. label var prior_vacc_likely "Prior: SE likely with vaccine"

. 
. * Do not intend to vaccinate (from prescreen, vacc_intent == 1)
. gen pre_no_intent = (pre_vacc_intent_pre == 1) if ~missing(pre_vacc_intent_pr
> e)
(13 missing values generated)

. label var pre_no_intent "Do not intend to vaccinate"

. 
. * Previously had flu vaccine
. gen pre_had_flu = had_prior_flu_vacc
(13 missing values generated)

. label var pre_had_flu "Previously had flu vaccine"

. 
. * Previously had COVID vaccine
. gen pre_had_covid = had_prior_covid_vacc
(13 missing values generated)

. label var pre_had_covid "Previously had COVID vaccine"

. 
. * Severe flu vaccine reaction (conditional on having had flu vacc)
. gen severe_flu_reaction = (flu_vacc_reaction == 3) if had_prior_flu_vacc == 1
(1,444 missing values generated)

. label var severe_flu_reaction "Severe flu vaccine reaction"

. 
. * Severe COVID vaccine reaction (conditional on having had COVID vacc)
. gen severe_covid_reaction = (covid_vacc_reaction == 3) if had_prior_covid_vac
> c == 1
(1,312 missing values generated)

. label var severe_covid_reaction "Severe COVID vaccine reaction"

. 
. * Has health condition (cond_none == 0, conditional on not missing)
. gen has_condition = (cond_none == 0) if ~missing(cond_none)
(13 missing values generated)

. label var has_condition "Has health condition"

. 
. * Age 18-34 (age == 2)
. gen age_18_34 = (age == 2) if ~missing(age) & age != -99
(9 missing values generated)

. label var age_18_34 "Age 18--34"

. 
. * Age 35-49 (age == 3)
. gen age_35_49 = (age == 3) if ~missing(age) & age != -99
(9 missing values generated)

. label var age_35_49 "Age 35--49"

. 
. * Race = white (race == 1)
. gen race_white = (race == 1) if ~missing(race) & race != 7
(38 missing values generated)

. label var race_white "White"

. 
. * Ethnicity = Hispanic (ethnicity == 1)
. gen hispanic = (ethnicity == 1) if ~missing(ethnicity) & ethnicity != 3
(34 missing values generated)

. label var hispanic "Hispanic"

. 
. * Income < 50k (income == 1 or 2)
. gen income_lt50k = (income <= 2) if ~missing(income) & income != 6
(95 missing values generated)

. label var income_lt50k "Income under 50k"

. 
. * Trust government somewhat or strongly (trust_govt >= 4)
. gen trust_govt_high = (trust_govt >= 4) if ~missing(trust_govt)
(13 missing values generated)

. label var trust_govt_high "Trust government"

. 
. * Follow doctor somewhat or strongly (follow_doctor >= 4)
. gen follow_doc_high = (follow_doctor >= 4) if ~missing(follow_doctor)
(13 missing values generated)

. label var follow_doc_high "Follow doctor advice"

. 
. * College degree (education == 4 or 5)
. gen college = (education == 4 | education == 5) if ~missing(education) & educ
> ation != 6
(21 missing values generated)

. label var college "College degree"

. 
. /*---------------------------------------------------------------------------
> ---
>     3. Define variable list for balance table
> -----------------------------------------------------------------------------
> -*/
. 
. local balance_vars ///
>     prior_vacc_likely ///
>     pre_no_intent ///
>     pre_had_flu ///
>     pre_had_covid ///
>     severe_flu_reaction ///
>     severe_covid_reaction ///
>     has_condition ///
>     age_18_34 ///
>     age_35_49 ///
>     race_white ///
>     hispanic ///
>     income_lt50k ///
>     trust_govt_high ///
>     follow_doc_high ///
>     college

. 
. /*---------------------------------------------------------------------------
> ---
>     4. Calculate sample sizes by arm
> -----------------------------------------------------------------------------
> -*/
. 
. * Get sample sizes for each arm (using a variable with no missings for full s
> ample)
. count if arm_n == 0
  885

. local N0 = r(N)

. count if arm_n == 1
  885

. local N1 = r(N)

. count if arm_n == 2
  882

. local N2 = r(N)

. count if arm_n == 3
  886

. local N3 = r(N)

. local N_total = `N0' + `N1' + `N2' + `N3'

. 
. di "Sample sizes: Control=`N0' Industry=`N1' Academic=`N2' Personal=`N3' Tota
> l=`N_total'"
Sample sizes: Control=885 Industry=885 Academic=882 Personal=886 Total=3538

. 
. /*---------------------------------------------------------------------------
> ---
>     5. Calculate means by treatment arm and p-values (robust SEs)
> -----------------------------------------------------------------------------
> -*/
. 
. * Open output file
. capture file close fout

. file open fout using "output/tables/balance_table.csv", write replace

. file write fout "Variable,Control,Industry,Academic,Personal,P-value" _n

. 
. foreach var of local balance_vars {
  2.     * Get variable label for display
.     local varlabel: variable label `var'
  3.     if "`varlabel'" == "" local varlabel "`var'"
  4. 
.     * Get means by arm
.     quietly {
  5.         sum `var' if arm_n == 0
  6.         local mean0 = r(mean)
  7. 
.         sum `var' if arm_n == 1
  8.         local mean1 = r(mean)
  9. 
.         sum `var' if arm_n == 2
 10.         local mean2 = r(mean)
 11. 
.         sum `var' if arm_n == 3
 12.         local mean3 = r(mean)
 13.     }
 14. 
.     * Test joint equality (F-test from regression with robust SEs)
.     quietly regress `var' i.arm_n, vce(robust)
 15.     quietly testparm i.arm_n
 16.     local pval = r(p)
 17. 
.     * Format means (3 decimal places)
.     local mean0_fmt: di %6.3f `mean0'
 18.     local mean1_fmt: di %6.3f `mean1'
 19.     local mean2_fmt: di %6.3f `mean2'
 20.     local mean3_fmt: di %6.3f `mean3'
 21.     local pval_fmt: di %6.3f `pval'
 22. 
.     * Write to CSV (use label for row name)
.     file write fout "`varlabel',`mean0_fmt',`mean1_fmt',`mean2_fmt',`mean3_fm
> t',`pval_fmt'" _n
 23. 
.     di "`varlabel': Control=`mean0_fmt' Industry=`mean1_fmt' Academic=`mean2_
> fmt' Personal=`mean3_fmt' p=`pval_fmt'"
 24. }
Prior: SE likely with vaccine: Control= 0.551 Industry= 0.541 Academic= 0.533 P
> ersonal= 0.529 p= 0.794
Do not intend to vaccinate: Control= 0.655 Industry= 0.666 Academic= 0.674 Pers
> onal= 0.662 p= 0.870
Previously had flu vaccine: Control= 0.600 Industry= 0.624 Academic= 0.560 Pers
> onal= 0.592 p= 0.055
Previously had COVID vaccine: Control= 0.627 Industry= 0.642 Academic= 0.625 Pe
> rsonal= 0.632 p= 0.876
Severe flu vaccine reaction: Control= 0.108 Industry= 0.093 Academic= 0.089 Per
> sonal= 0.105 p= 0.703
Severe COVID vaccine reaction: Control= 0.170 Industry= 0.144 Academic= 0.135 P
> ersonal= 0.168 p= 0.256
Has health condition: Control= 0.164 Industry= 0.216 Academic= 0.163 Personal= 
> 0.177 p= 0.016
Age 18--34: Control= 0.351 Industry= 0.343 Academic= 0.333 Personal= 0.322 p= 0
> .588
Age 35--49: Control= 0.400 Industry= 0.386 Academic= 0.420 Personal= 0.389 p= 0
> .444
White: Control= 0.764 Industry= 0.759 Academic= 0.747 Personal= 0.761 p= 0.862
Hispanic: Control= 0.081 Industry= 0.096 Academic= 0.100 Personal= 0.092 p= 0.5
> 36
Income under 50k: Control= 0.350 Industry= 0.399 Academic= 0.382 Personal= 0.35
> 9 p= 0.146
Trust government: Control= 0.471 Industry= 0.451 Academic= 0.453 Personal= 0.44
> 7 p= 0.773
Follow doctor advice: Control= 0.568 Industry= 0.550 Academic= 0.548 Personal= 
> 0.566 p= 0.755
College degree: Control= 0.535 Industry= 0.505 Academic= 0.495 Personal= 0.519 
> p= 0.363

. 
. file close fout

. 
. /*---------------------------------------------------------------------------
> ---
>     6. Joint F-test for all variables (SUR approach)
> -----------------------------------------------------------------------------
> -*/
. 
. di ""


. di "=== JOINT BALANCE TEST ==="
=== JOINT BALANCE TEST ===

. 
. * Use seemingly unrelated regression for joint test
. quietly {

. 
. di "Joint chi-squared(`joint_df') = " %8.3f `joint_chi2'
Joint chi-squared(45) =   44.190

. di "Joint p-value = " %6.3f `joint_p'
Joint p-value =  0.506

. 
. * Append joint test and sample sizes to CSV
. file open fout using "output/tables/balance_table.csv", write append

. file write fout _n

. local joint_chi2_fmt: di %8.3f `joint_chi2'

. local joint_p_fmt: di %6.3f `joint_p'

. file write fout "Joint test,chi2(`joint_df')=`joint_chi2_fmt',,,`joint_p_fmt'
> " _n

. file write fout _n

. file write fout "N,`N0',`N1',`N2',`N3'," _n

. file close fout

. 
. /*---------------------------------------------------------------------------
> ---
>     7. Create LaTeX table body (no headers/metadata - just insertable content
> )
> -----------------------------------------------------------------------------
> -*/
. 
. file open texout using "output/tables/balance_table.tex", write replace

. 
. * Write each variable row
. foreach var of local balance_vars {
  2.     * Get means by arm
.     quietly {
  3.         sum `var' if arm_n == 0
  4.         local mean0 = r(mean)
  5. 
.         sum `var' if arm_n == 1
  6.         local mean1 = r(mean)
  7. 
.         sum `var' if arm_n == 2
  8.         local mean2 = r(mean)
  9. 
.         sum `var' if arm_n == 3
 10.         local mean3 = r(mean)
 11.     }
 12. 
.     * Test joint equality (robust SEs)
.     quietly regress `var' i.arm_n, vce(robust)
 13.     quietly testparm i.arm_n
 14.     local pval = r(p)
 15. 
.     * Get variable label
.     local varlabel: variable label `var'
 16.     if "`varlabel'" == "" local varlabel "`var'"
 17. 
.     * Format for LaTeX (3 decimal places)
.     local mean0_fmt: di %5.3f `mean0'
 18.     local mean1_fmt: di %5.3f `mean1'
 19.     local mean2_fmt: di %5.3f `mean2'
 20.     local mean3_fmt: di %5.3f `mean3'
 21.     local pval_fmt: di %5.3f `pval'
 22. 
.     file write texout "`varlabel' & `mean0_fmt' & `mean1_fmt' & `mean2_fmt' &
>  `mean3_fmt' & `pval_fmt' \\" _n
 23. }

. 
. * Add separator and joint test row
. file write texout "\addlinespace" _n

. local joint_chi2_fmt: di %5.3f `joint_chi2'

. local joint_p_fmt: di %5.3f `joint_p'

. file write texout "Joint test & \multicolumn{4}{c}{\$\chi^2(`joint_df')=`join
> t_chi2_fmt'\$} & `joint_p_fmt' \\" _n

. 
. * Add sample size row
. file write texout "\addlinespace" _n

. file write texout "N & `N0' & `N1' & `N2' & `N3' & \\" _n

. 
. file close texout

. 
. di ""


. di "=== BALANCE TABLE COMPLETE ==="
=== BALANCE TABLE COMPLETE ===

. di "Saved: output/tables/balance_table.csv"
Saved: output/tables/balance_table.csv

. di "Saved: output/tables/balance_table.tex"
Saved: output/tables/balance_table.tex

. 
. capture log close

. 
end of do-file

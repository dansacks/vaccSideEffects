
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       SE—Standard Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user network, expiring 23 Oct 2026
Serial number: 401909300710
  Licensed to: Daniel Sacks
               

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do /Users/sacks/Projects/VaccSideEffects/code/clean_prolific_demographics.do 

. /*===========================================================================
> ===
>     Clean Prolific Demographic Exports
> 
>     Input:  raw_data/prolific_demographic_export_*.csv
>     Output: derived/prolific_demographics_prescreen.dta
>             derived/prolific_demographics_main.dta
>             derived/prolific_demographics_main_morepay.dta
>             derived/prolific_demographics_followup.dta
> 
>     Cleans prolific demographic data for merging with survey data.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "clean_prolific_demographics"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory based on operating system
. * c(os) returns "Windows" on Windows, "Unix" or "MacOSX" on Mac
. local usr `c(username)'

. if "`c(os)'" == "Windows" {
.     global projdir "C:/Users/`usr'/Projects/VaccSideEffects"
. }

. else {
.     * macOS (Unix or MacOSX)
.     global projdir "/Users/`usr'/Projects/VaccSideEffects"
. }

. cd "$projdir"
/Users/sacks/Projects/VaccSideEffects

. 
. * Add local ado files to path (for plot_to_csv and other custom programs)
. adopath + "$projdir/code/include"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"

. adopath + "$projdir/code/ado"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"
  [8]              "/Users/sacks/Projects/VaccSideEffects/code/ado"

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. /*---------------------------------------------------------------------------
> ---
>     Named Constants
> 
>     These replace magic numbers scattered throughout the codebase.
> -----------------------------------------------------------------------------
> -*/
. 
. * Attention check expected values (from survey design)
. global ATTN_CHECK_PRESCREEN = 1965

. global ATTN_CHECK_MAIN = 4419

. global ATTN_CHECK_FOLLOWUP = 1163

. 
. * Special code for unselected responses
. global UNSELECTED_VALUE  = -99

. 
. * Special code for "prefer not to say" responses (same as unselected)
. global PREF_NOT_SAY = -99

. 
. /*---------------------------------------------------------------------------
> ---
>     Conditional Logging
> -----------------------------------------------------------------------------
> -*/
. 
. * Only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/sacks/Projects/VaccSideEffects/output/logs/clean_prolific_d
> emographics.log
  log type:  text
 opened on:  27 Jan 2026, 12:48:02
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: clean_prolific_demographics ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/clean_prolific_demographics.log
.     di ""

. }

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     Program to clean a single prolific demographic file
> -----------------------------------------------------------------------------
> -*/
. 
. capture program drop clean_prolific

. program define clean_prolific
  1.     args infile outfile
  2. 
.     di ""
  3.     di "=== Cleaning: `infile' ==="
  4. 
.     * Import CSV
.     import delimited using "`infile'", clear varnames(1) stringcols(_all)
  5. 
.     * Rename key variables
.     rename submissionid prolific_submission_id
  6.     rename participantid prolific_pid
  7.     rename status prolific_status
  8.     rename startedat prolific_started
  9.     rename completedat prolific_completed
 10.     rename timetaken prolific_duration
 11.     rename totalapprovals prolific_approvals
 12. 
.     * Clean demographics
.     rename age prolific_age
 13.     rename sex prolific_sex
 14.     rename ethnicitysimplified prolific_ethnicity
 15.     rename countryofbirth prolific_country_birth
 16.     rename countryofresidence prolific_country_residence
 17.     rename nationality prolific_nationality
 18.     rename language prolific_language
 19.     rename studentstatus prolific_student
 20.     rename employmentstatus prolific_employment
 21. 
.     * Convert numeric variables
.     destring prolific_age, replace force
 22.     destring prolific_duration, replace force
 23.     destring prolific_approvals, replace force
 24. 
.     * Clean string variables - handle DATA_EXPIRED
.     foreach var in prolific_student prolific_employment {
 25.         replace `var' = "" if `var' == "DATA_EXPIRED"
 26.     }
 27. 
.     * Create numeric codes for categorical variables
. 
.     * Sex
.     gen prolific_female = (prolific_sex == "Female") if prolific_sex != ""
 28.     gen prolific_male = (prolific_sex == "Male") if prolific_sex != ""
 29.     label var prolific_female "Female (Prolific)"
 30.     label var prolific_male "Male (Prolific)"
 31. 
.     * Ethnicity
.     encode prolific_ethnicity, gen(prolific_ethnicity_n)
 32.     label var prolific_ethnicity_n "Ethnicity (Prolific, numeric)"
 33. 
.     * Student status
.     gen prolific_is_student = (prolific_student == "Yes") if prolific_student
>  != ""
 34.     label var prolific_is_student "Currently a student (Prolific)"
 35. 
.     * Employment - create categories
.     gen prolific_employed_ft = strpos(prolific_employment, "Full-Time") > 0 i
> f prolific_employment != ""
 36.     gen prolific_employed_pt = strpos(prolific_employment, "Part-Time") > 
> 0 if prolific_employment != ""
 37.     gen prolific_not_working = strpos(prolific_employment, "Not in paid wo
> rk") > 0 if prolific_employment != ""
 38.     gen prolific_unemployed = strpos(prolific_employment, "Unemployed") > 
> 0 if prolific_employment != ""
 39.     label var prolific_employed_ft "Employed full-time (Prolific)"
 40.     label var prolific_employed_pt "Employed part-time (Prolific)"
 41.     label var prolific_not_working "Not in paid work (Prolific)"
 42.     label var prolific_unemployed "Unemployed (Prolific)"
 43. 
.     * Keep only relevant variables
.     keep prolific_pid prolific_submission_id prolific_status ///
>          prolific_started prolific_completed prolific_duration prolific_appro
> vals ///
>          prolific_age prolific_sex prolific_female prolific_male ///
>          prolific_ethnicity prolific_ethnicity_n ///
>          prolific_country_birth prolific_country_residence prolific_nationali
> ty ///
>          prolific_language prolific_student prolific_is_student ///
>          prolific_employment prolific_employed_ft prolific_employed_pt ///
>          prolific_not_working prolific_unemployed
 44. 
.     * Label core variables
.     label var prolific_pid "Prolific participant ID"
 45.     label var prolific_submission_id "Prolific submission ID"
 46.     label var prolific_status "Prolific submission status"
 47.     label var prolific_started "Prolific start time"
 48.     label var prolific_completed "Prolific completion time"
 49.     label var prolific_duration "Time taken (seconds, Prolific)"
 50.     label var prolific_approvals "Total approvals (Prolific)"
 51.     label var prolific_age "Age (Prolific)"
 52.     label var prolific_sex "Sex (Prolific)"
 53.     label var prolific_ethnicity "Ethnicity simplified (Prolific)"
 54.     label var prolific_country_birth "Country of birth (Prolific)"
 55.     label var prolific_country_residence "Country of residence (Prolific)"
 56.     label var prolific_nationality "Nationality (Prolific)"
 57.     label var prolific_language "Language (Prolific)"
 58.     label var prolific_student "Student status (Prolific)"
 59.     label var prolific_employment "Employment status (Prolific)"
 60. 
.     * Check for duplicates
.     duplicates report prolific_pid
 61. 
.     * Compress and save
.     compress
 62.     save "`outfile'", replace
 63. 
.     di "Saved: `outfile'"
 64.     di "Observations: " _N
 65. end

. 
. /*---------------------------------------------------------------------------
> ---
>     Clean each file
> -----------------------------------------------------------------------------
> -*/
. 
. * Prescreen (long string filename)
. clean_prolific ///
>     "raw_data/prolific_demographic_export_692494f77a877e57e000eb60.csv" ///
>     "derived/prolific_demographics_prescreen.dta"

=== Cleaning: raw_data/prolific_demographic_export_692494f77a877e57e000eb60.csv
>  ===
(encoding automatically selected: ISO-8859-1)
(26 vars, 8,216 obs)
prolific_age: contains nonnumeric characters; replaced as int
(168 missing values generated)
prolific_duration: all characters numeric; replaced as long
(164 missing values generated)
prolific_approvals: all characters numeric; replaced as int
(1,795 real changes made)
(1,825 real changes made)
(1,795 missing values generated)
(1,825 missing values generated)
(1,825 missing values generated)
(1,825 missing values generated)
(1,825 missing values generated)

Duplicates in terms of prolific_pid

--------------------------------------
   Copies | Observations       Surplus
----------+---------------------------
        1 |         8216             0
--------------------------------------
  variable prolific_female was float now byte
  variable prolific_male was float now byte
  variable prolific_ethnicity_n was long now byte
  variable prolific_is_student was float now byte
  variable prolific_employed_ft was float now byte
  variable prolific_employed_pt was float now byte
  variable prolific_not_working was float now byte
  variable prolific_unemployed was float now byte
  (197,184 bytes saved)
file derived/prolific_demographics_prescreen.dta saved
Saved: derived/prolific_demographics_prescreen.dta
Observations: 8216

. 
. * Main
. clean_prolific ///
>     "raw_data/prolific_demographic_export_main.csv" ///
>     "derived/prolific_demographics_main.dta"

=== Cleaning: raw_data/prolific_demographic_export_main.csv ===
(encoding automatically selected: ISO-8859-1)
(30 vars, 2,752 obs)
prolific_age: contains nonnumeric characters; replaced as byte
(68 missing values generated)
prolific_duration: all characters numeric; replaced as long
(67 missing values generated)
prolific_approvals: all characters numeric; replaced as int
(566 real changes made)
(574 real changes made)
(566 missing values generated)
(574 missing values generated)
(574 missing values generated)
(574 missing values generated)
(574 missing values generated)

Duplicates in terms of prolific_pid

--------------------------------------
   Copies | Observations       Surplus
----------+---------------------------
        1 |         2752             0
--------------------------------------
  variable prolific_female was float now byte
  variable prolific_male was float now byte
  variable prolific_ethnicity_n was long now byte
  variable prolific_is_student was float now byte
  variable prolific_employed_ft was float now byte
  variable prolific_employed_pt was float now byte
  variable prolific_not_working was float now byte
  variable prolific_unemployed was float now byte
  (66,048 bytes saved)
file derived/prolific_demographics_main.dta saved
Saved: derived/prolific_demographics_main.dta
Observations: 2752

. 
. * Main morepay
. clean_prolific ///
>     "raw_data/prolific_demographic_export_main_morepay.csv" ///
>     "derived/prolific_demographics_main_morepay.dta"

=== Cleaning: raw_data/prolific_demographic_export_main_morepay.csv ===
(encoding automatically selected: ISO-8859-1)
(30 vars, 904 obs)
prolific_age: contains nonnumeric characters; replaced as byte
(22 missing values generated)
prolific_duration: all characters numeric; replaced as long
(22 missing values generated)
prolific_approvals: all characters numeric; replaced as int
(176 real changes made)
(180 real changes made)
(176 missing values generated)
(180 missing values generated)
(180 missing values generated)
(180 missing values generated)
(180 missing values generated)

Duplicates in terms of prolific_pid

--------------------------------------
   Copies | Observations       Surplus
----------+---------------------------
        1 |          904             0
--------------------------------------
  variable prolific_female was float now byte
  variable prolific_male was float now byte
  variable prolific_ethnicity_n was long now byte
  variable prolific_is_student was float now byte
  variable prolific_employed_ft was float now byte
  variable prolific_employed_pt was float now byte
  variable prolific_not_working was float now byte
  variable prolific_unemployed was float now byte
  (21,696 bytes saved)
file derived/prolific_demographics_main_morepay.dta saved
Saved: derived/prolific_demographics_main_morepay.dta
Observations: 904

. 
. * Followup
. clean_prolific ///
>     "raw_data/prolific_demographic_export_followup.csv" ///
>     "derived/prolific_demographics_followup.dta"

=== Cleaning: raw_data/prolific_demographic_export_followup.csv ===
(encoding automatically selected: ISO-8859-1)
(25 vars, 3,192 obs)
prolific_age: contains nonnumeric characters; replaced as byte
(70 missing values generated)
prolific_duration: all characters numeric; replaced as long
(70 missing values generated)
prolific_approvals: all characters numeric; replaced as int
(638 real changes made)
(643 real changes made)
(638 missing values generated)
(643 missing values generated)
(643 missing values generated)
(643 missing values generated)
(643 missing values generated)

Duplicates in terms of prolific_pid

--------------------------------------
   Copies | Observations       Surplus
----------+---------------------------
        1 |         3192             0
--------------------------------------
  variable prolific_female was float now byte
  variable prolific_male was float now byte
  variable prolific_ethnicity_n was long now byte
  variable prolific_is_student was float now byte
  variable prolific_employed_ft was float now byte
  variable prolific_employed_pt was float now byte
  variable prolific_not_working was float now byte
  variable prolific_unemployed was float now byte
  (76,608 bytes saved)
file derived/prolific_demographics_followup.dta saved
Saved: derived/prolific_demographics_followup.dta
Observations: 3192

. 
. /*---------------------------------------------------------------------------
> ---
>     Summary
> -----------------------------------------------------------------------------
> -*/
. 
. di ""


. di "=== All prolific demographic files cleaned ==="
=== All prolific demographic files cleaned ===

. 
. capture log close

. 
end of do-file

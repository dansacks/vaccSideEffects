
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       SE—Standard Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user network, expiring 23 Oct 2026
Serial number: 401909300710
  Licensed to: Daniel Sacks
               

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do /Users/sacks/Projects/VaccSideEffects/code/count_sample_size.do 

. /*===========================================================================
> ===
>     Count Sample Sizes at Various Inclusion Criteria
> 
>     Input:  derived/prescreen_clean.dta
>             derived/main_clean.dta
>             derived/followup_clean.dta
>             derived/prolific_demographics_*.dta
>     Output: output/tables/counts.csv
> 
>     Counts sample sizes as observations pass through sequential filters.
>     Also counts matches to Prolific demographics (after final sample).
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "count_sample_size"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory based on operating system
. * c(os) returns "Windows" on Windows, "Unix" or "MacOSX" on Mac
. local usr `c(username)'

. if "`c(os)'" == "Windows" {
.     global projdir "C:/Users/`usr'/Projects/VaccSideEffects"
. }

. else {
.     * macOS (Unix or MacOSX)
.     global projdir "/Users/`usr'/Projects/VaccSideEffects"
. }

. cd "$projdir"
/Users/sacks/Projects/VaccSideEffects

. 
. * Add local ado files to path (for plot_to_csv and other custom programs)
. adopath + "$projdir/code/include"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"

. adopath + "$projdir/code/ado"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"
  [8]              "/Users/sacks/Projects/VaccSideEffects/code/ado"

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. /*---------------------------------------------------------------------------
> ---
>     Named Constants
> 
>     These replace magic numbers scattered throughout the codebase.
> -----------------------------------------------------------------------------
> -*/
. 
. * Attention check expected values (from survey design)
. global ATTN_CHECK_PRESCREEN = 1965

. global ATTN_CHECK_MAIN = 4419

. global ATTN_CHECK_FOLLOWUP = 1163

. 
. * Special code for unselected responses
. global UNSELECTED_VALUE  = -99

. 
. /*---------------------------------------------------------------------------
> ---
>     Conditional Logging
> -----------------------------------------------------------------------------
> -*/
. 
. * Only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/sacks/Projects/VaccSideEffects/output/logs/count_sample_siz
> e.log
  log type:  text
 opened on:  26 Jan 2026, 12:31:12
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: count_sample_size ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/count_sample_size.log
.     di ""

. }

. 
end of do-file

. 
. 
. /*---------------------------------------------------------------------------
> ---
>     1. Counts for pre-screen
> 
>     Sequential filters:
>     1. started prescreen (# non preview survey attempt)
>     2. consented
>     3. passed prescreen attention check
>     4. first attempt only
>     5. hesitant (vacc_intent is "don't intend" or "may or may not", i.e. <= 2
> )
>     + matches to demographics (not an inclusion criterion)
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/prescreen_clean.dta" if ~is_preview, clear

. 
. capture file close fout

. file open fout using "output/tables/counts.csv", write replace

. file write fout "Survey,Condition,Count" _n

. file write fout "Prescreen,Started (non-preview),`=_N'" _n

. 
. * Count after each sequential filter
. local n_started = _N

. keep if consent == 1
(105 observations deleted)

. local n_consent = _N

. file write fout "Prescreen,Consented,`=_N'" _n

. 
. keep if failed_attn == 0
(41 observations deleted)

. local n_attn = _N

. file write fout "Prescreen,Passed attention check,`=_N'" _n

. 
. keep if first_attempt == 1
(49 observations deleted)

. local n_first = _N

. file write fout "Prescreen,First attempt only,`=_N'" _n

. 
. keep if vacc_intent <= 2
(3,478 observations deleted)

. local n_hesitant = _N

. file write fout "Prescreen,Hesitant (final prescreen sample),`=_N'" _n

. 
. * Save prescreen final sample PIDs for linking
. preserve

. keep prolific_pid

. tempfile prescreen_final

. save `prescreen_final'
file /var/folders/_y/_xwy4y390t9bgphz7ts4mj540000gn/T//St56150.000002 saved
    as .dta format

. restore

. 
. * Count matches to demographics
. merge m:1 prolific_pid using "derived/prolific_demographics_prescreen.dta", k
> eep(1 3) keepusing(prolific_pid)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             4,525  (_merge==3)
    -----------------------------------------

. count if _merge == 3
  4,525

. local n_demog = r(N)

. file write fout "Prescreen,Matches to demographics,`n_demog'" _n

. drop _merge

. 
. di ""


. di "=== PRESCREEN SUMMARY ==="
=== PRESCREEN SUMMARY ===

. di "Started (non-preview): `n_started'"
Started (non-preview): 8198

. di "Consented: `n_consent'"
Consented: 8093

. di "Passed attention: `n_attn'"
Passed attention: 8052

. di "First attempt: `n_first'"
First attempt: 8003

. di "Hesitant (final): `n_hesitant'"
Hesitant (final): 4525

. di "Matches to demographics: `n_demog'"
Matches to demographics: 4525

. 
. /*---------------------------------------------------------------------------
> ---
>     2. Counts for main survey
> 
>     Sequential filters:
>     1. started (# non preview survey attempt)
>     2. linked to the final set from prescreen (hesitant + pass all other chec
> ks)
>     3. consented
>     4. passed attention check in main
>     5. non-missing value of delta (and no -99 in posterior_vacc, posterior_no
> vacc)
>     6. first attempt only - this is the main survey sample
>     + matches to demographics (not an inclusion criterion)
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/main_clean.dta" if ~is_preview, clear

. 
. file write fout _n

. file write fout "Main,Started (non-preview),`=_N'" _n

. local n_started = _N

. 
. * Merge with prescreen final sample
. merge m:1 prolific_pid using `prescreen_final', keep(1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            14
        from master                        14  (_merge==1)
        from using                          0  (_merge==2)

    Matched                             3,637  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(14 observations deleted)

. drop _merge

. local n_linked = _N

. file write fout "Main,Linked to prescreen final,`=_N'" _n

. 
. keep if consent == 1
(2 observations deleted)

. local n_consent = _N

. file write fout "Main,Consented,`=_N'" _n

. 
. keep if failed_attn == 0
(16 observations deleted)

. local n_attn = _N

. file write fout "Main,Passed attention check,`=_N'" _n

. 
. * Non-missing delta and no -99 values in posteriors
. keep if ~missing(delta) & posterior_vacc != -99 & posterior_novacc != -99
(72 observations deleted)

. local n_outcome = _N

. file write fout "Main,Non-missing delta (valid posteriors),`=_N'" _n

. 
. keep if first_attempt == 1
(21 observations deleted)

. local n_first = _N

. file write fout "Main,First attempt only (final main sample),`=_N'" _n

. 
. * Save main final sample PIDs for linking
. preserve

. keep prolific_pid

. tempfile main_final

. save `main_final'
file /var/folders/_y/_xwy4y390t9bgphz7ts4mj540000gn/T//St56150.000004 saved
    as .dta format

. restore

. 
. * Combine main and main_morepay demographics for matching
. preserve

. use "derived/prolific_demographics_main.dta", clear

. append using "derived/prolific_demographics_main_morepay.dta"
(variable prolific_country_birth was str33, now str36 to accommodate using
       data's values)
(label prolific_ethnicity_n already defined)

. duplicates drop prolific_pid, force

Duplicates in terms of prolific_pid

(0 observations are duplicates)

. tempfile main_demog_combined

. save `main_demog_combined'
file /var/folders/_y/_xwy4y390t9bgphz7ts4mj540000gn/T//St56150.000006 saved
    as .dta format

. restore

. 
. * Count matches to demographics
. merge m:1 prolific_pid using `main_demog_combined', keep(1 3) keepusing(proli
> fic_pid)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,526  (_merge==3)
    -----------------------------------------

. count if _merge == 3
  3,526

. local n_demog = r(N)

. file write fout "Main,Matches to demographics,`n_demog'" _n

. drop _merge

. 
. di ""


. di "=== MAIN SURVEY SUMMARY ==="
=== MAIN SURVEY SUMMARY ===

. di "Started (non-preview): `n_started'"
Started (non-preview): 3651

. di "Linked to prescreen: `n_linked'"
Linked to prescreen: 3637

. di "Consented: `n_consent'"
Consented: 3635

. di "Passed attention: `n_attn'"
Passed attention: 3619

. di "Non-missing delta: `n_outcome'"
Non-missing delta: 3547

. di "First attempt (final): `n_first'"
First attempt (final): 3526

. di "Matches to demographics: `n_demog'"
Matches to demographics: 3526

. 
. /*---------------------------------------------------------------------------
> ---
>     3. Counts for followup survey
> 
>     Sequential filters:
>     1. started (# non preview attempt)
>     2. linked to the final set from main survey
>     3. passed attention check in follow up
>     4. has non-missing outcome (got_flu_vacc)
>     5. first attempt only
>     + matches to demographics (not an inclusion criterion)
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/followup_clean.dta" if ~is_preview, clear

. 
. file write fout _n

. file write fout "Followup,Started (non-preview),`=_N'" _n

. local n_started = _N

. 
. * Merge with main final sample
. merge m:1 prolific_pid using `main_final', keep(1 3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            32
        from master                        32  (_merge==1)
        from using                          0  (_merge==2)

    Matched                             3,178  (_merge==3)
    -----------------------------------------

. keep if _merge == 3
(32 observations deleted)

. drop _merge

. local n_linked = _N

. file write fout "Followup,Linked to main final,`=_N'" _n

. 
. keep if failed_attn == 0
(44 observations deleted)

. local n_attn = _N

. file write fout "Followup,Passed attention check,`=_N'" _n

. 
. keep if ~missing(got_flu_vacc)
(60 observations deleted)

. local n_outcome = _N

. file write fout "Followup,Has non-missing outcome,`=_N'" _n

. 
. keep if first_attempt == 1
(28 observations deleted)

. local n_first = _N

. file write fout "Followup,First attempt only (final followup sample),`=_N'" _
> n

. 
. * Count matches to demographics
. merge m:1 prolific_pid using "derived/prolific_demographics_followup.dta", ke
> ep(1 3) keepusing(prolific_pid)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,046  (_merge==3)
    -----------------------------------------

. count if _merge == 3
  3,046

. local n_demog = r(N)

. file write fout "Followup,Matches to demographics,`n_demog'" _n

. drop _merge

. 
. di ""


. di "=== FOLLOWUP SUMMARY ==="
=== FOLLOWUP SUMMARY ===

. di "Started (non-preview): `n_started'"
Started (non-preview): 3210

. di "Linked to main: `n_linked'"
Linked to main: 3178

. di "Passed attention: `n_attn'"
Passed attention: 3134

. di "Non-missing outcome: `n_outcome'"
Non-missing outcome: 3074

. di "First attempt (final): `n_first'"
First attempt (final): 3046

. di "Matches to demographics: `n_demog'"
Matches to demographics: 3046

. 
. file close fout

. 
. di ""


. di "=== SAMPLE SIZE COUNTS COMPLETE ==="
=== SAMPLE SIZE COUNTS COMPLETE ===

. di "Saved: output/tables/counts.csv"
Saved: output/tables/counts.csv

. 
. capture log close

. 
end of do-file

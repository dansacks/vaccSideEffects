
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       SE—Standard Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user network, expiring 23 Oct 2026
Serial number: 401909300710
  Licensed to: Daniel Sacks
               

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do /Users/sacks/Projects/VaccSideEffects/code/merge_prescreen_main.do 

. /*===========================================================================
> ===
>     Merge Prescreen and Main Survey Data
> 
>     Input:  data/prescreen_clean.dta
>             data/main_clean.dta
>     Output: data/merged_main_pre.dta
> 
>     Merges on prolific_pid. Renames conflicting variables with prefixes.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "merge_prescreen_main"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory based on operating system
. * c(os) returns "Windows" on Windows, "Unix" or "MacOSX" on Mac
. local usr `c(username)'

. if "`c(os)'" == "Windows" {
.     global projdir "C:/Users/`usr'/Projects/VaccSideEffects"
. }

. else {
.     * macOS (Unix or MacOSX)
.     global projdir "/Users/`usr'/Projects/VaccSideEffects"
. }

. cd "$projdir"
/Users/sacks/Projects/VaccSideEffects

. 
. * Add local ado files to path (for plot_to_csv and other custom programs)
. adopath + "$projdir/code/include"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"

. adopath + "$projdir/code/ado"
  [1]  (BASE)      "/Applications/StataNow/ado/base/"
  [2]  (SITE)      "/Applications/StataNow/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Users/sacks/Documents/Stata/ado/personal/"
  [5]  (PLUS)      "/Users/sacks/Library/Application Support/Stata/ado/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/sacks/Projects/VaccSideEffects/code/include"
  [8]              "/Users/sacks/Projects/VaccSideEffects/code/ado"

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. /*---------------------------------------------------------------------------
> ---
>     Named Constants
> 
>     These replace magic numbers scattered throughout the codebase.
> -----------------------------------------------------------------------------
> -*/
. 
. * Attention check expected values (from survey design)
. global ATTN_CHECK_PRESCREEN = 1965

. global ATTN_CHECK_MAIN = 4419

. global ATTN_CHECK_FOLLOWUP = 1163

. 
. * Special code for unselected responses
. global UNSELECTED_VALUE  = -99

. 
. * Special code for "prefer not to say" responses (same as unselected)
. global PREF_NOT_SAY = -99

. 
. /*---------------------------------------------------------------------------
> ---
>     Conditional Logging
> -----------------------------------------------------------------------------
> -*/
. 
. * Only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/sacks/Projects/VaccSideEffects/output/logs/merge_prescreen_
> main.log
  log type:  text
 opened on:  27 Jan 2026, 13:08:52
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: merge_prescreen_main ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/merge_prescreen_main.log
.     di ""

. }

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     1. Load and prepare prescreen data
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/prescreen_clean.dta" if final_sample , clear

. 
. 
. * Rename conflicting variables with pre_ prefix
. rename response_id pre_response_id

. rename prolific_id_entered pre_prolific_id_entered

. rename start_date pre_start_date

. rename end_date pre_end_date

. rename duration_sec pre_duration_sec

. rename progress pre_progress

. rename consent pre_consent

. rename final_sample pre_final_sample

. rename incomplete pre_incomplete

. rename failed_attn pre_failed_attn

. rename pid_mismatch pre_pid_mismatch

. rename duplicate_pid pre_duplicate_pid

. rename comments pre_comments

. rename vacc_intent pre_vacc_intent

. 
. * Rename missing indicators with pre_ prefix
. rename vacc_intent_miss pre_vacc_intent_miss

. rename had_prior_covid_vacc_miss pre_had_prior_covid_vacc_miss

. rename had_prior_flu_vacc_miss pre_had_prior_flu_vacc_miss

. rename covid_vacc_reaction_miss pre_covid_vacc_reaction_miss

. rename flu_vacc_reaction_miss pre_flu_vacc_reaction_miss

. 
. * Keep the key variable unchanged
. * prolific_pid is the merge key
. 
. * Save temporary file
. tempfile prescreen

. save `prescreen'
file /var/folders/_y/_xwy4y390t9bgphz7ts4mj540000gn/T//St89961.000001 saved
    as .dta format

. 
. di "Prescreen observations: " _N
Prescreen observations: 8003

. 
. /*---------------------------------------------------------------------------
> ---
>     2. Load and prepare main data
> -----------------------------------------------------------------------------
> -*/
. 
. use "derived/main_clean.dta" if final_sample, clear

. 
. 
. * Rename conflicting variables with main_ prefix
. rename response_id main_response_id

. rename prolific_id_entered main_prolific_id_entered

. rename start_date main_start_date

. rename end_date main_end_date

. rename duration_sec main_duration_sec

. rename progress main_progress

. rename consent main_consent

. rename final_sample main_final_sample

. rename incomplete main_incomplete

. rename failed_attn main_failed_attn

. rename pid_mismatch main_pid_mismatch

. rename duplicate_pid main_duplicate_pid

. rename comments main_comments

. 
. * Rename vacc_intentions to distinguish from prescreen's flu_vax_intent
. rename vacc_intent main_vacc_intent

. label var main_vacc_intent "Main survey: flu vaccine intentions"

. 
. * Update maybe variable name for clarity
. rename maybe main_maybe

. label var main_maybe "Main survey: intends/already got vaccine"

. 
. di "Main observations: " _N
Main observations: 3538

. 
. /*---------------------------------------------------------------------------
> ---
>     3. Merge datasets
> -----------------------------------------------------------------------------
> -*/
. 
. * Merge prescreen into main (1:1 on prolific_pid)
. merge 1:1 prolific_pid using `prescreen', update keep(1 3 4 5)
(label yesno already defined)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         4  (_merge==1)
        from using                          0  (_merge==2)

    Matched                             3,534
        not updated                     3,534  (_merge==3)
        missing updated                     0  (_merge==4)
        nonmissing conflict                 0  (_merge==5)
    -----------------------------------------

. assert _merge <= 3 

. 
. * Create merge indicator
. gen in_pre= (_merge == 3)

. label var in_pre "Observation in pre-screen and main data"

. 
. * Summary
. di ""


. di "=== MERGE SUMMARY ==="
=== MERGE SUMMARY ===

. count if _merge == 1
  4

. di "In main only (not in prescreen): " r(N)
In main only (not in prescreen): 4

. count if _merge == 2
  0

. di "In prescreen only (not in main): " r(N)
In prescreen only (not in main): 0

. count if _merge == 3
  3,534

. di "In both: " r(N)
In both: 3534

. 
. * List observations in main only (should be none - investigate if any exist)
. count if _merge == 1
  4

. if r(N) > 0 {
.     di ""

.     di "=== WARNING: " r(N) " observations in main but not prescreen ==="
=== WARNING: 4 observations in main but not prescreen ===
.     di "Exporting to output/logs/main_only_observations.csv"
Exporting to output/logs/main_only_observations.csv
.     preserve
.     keep if _merge == 1
(3,534 observations deleted)
.     keep prolific_pid main_response_id main_start_date main_consent arm_n
.     export delimited using "output/logs/main_only_observations.csv", replace
file output/logs/main_only_observations.csv saved
.     restore
. }

. 
. 
. 
. /*---------------------------------------------------------------------------
> ---
>     4. save
> -----------------------------------------------------------------------------
> -*/
. 
. * Variable count
. desc, short

Contains data from derived/main_clean.dta
 Observations:         3,538                  
    Variables:           183                  27 Jan 2026 13:08
Sorted by: prolific_pid
     Note: Dataset has changed since last saved.

. di "Total variables: " r(k)
Total variables: 183

. 
. * Drop merge indicator
. drop _merge

. 
. * Create main_sample flag: in both prescreen and main final samples
. gen main_sample = (pre_final_sample==1 & main_final_sample==1)

. label var main_sample "In final sample for main analysis (pre + main)"

. 
. count if main_sample==1
  3,534

. di "Main analysis sample: " r(N)
Main analysis sample: 3534

. 
. * Compress and save
. compress
  variable attn_check was long now int
  variable pre_duration_sec was long now int
  variable in_pre was float now byte
  variable main_sample was float now byte
  variable favorite_number was double now int
  variable pre_prolific_id_entered was str67 now str24
  variable source_news_text was str243 now str169
  debrief_about is strL now coalesced
  main_comments is strL now coalesced
  (615,530 bytes saved)

. save "derived/merged_main_pre.dta", replace
file derived/merged_main_pre.dta saved

. 
. di ""


. di "=== MERGE COMPLETE ==="
=== MERGE COMPLETE ===

. di "Saved: derived/merged_main_pre.dta"
Saved: derived/merged_main_pre.dta

. 
. capture log close

. 
end of do-file

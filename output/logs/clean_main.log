
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      Stata 18.0
___/   /   /___/   /   /___/       SE—Standard Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: Unlimited-user network, expiring 23 Oct 2026
Serial number: 401909300710
  Licensed to: Wisconsin School of Business
               University of Wisconsin - Madison

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do C:/Users/dwsacks/projects/vaccSideEffects/code/clean_main.do 

. /*===========================================================================
> ===
>     Clean Main Survey Data
> 
>     Input:  data/flu_survey_main_*.sav (SPSS export from Qualtrics)
>     Output: data/main_clean.dta
> 
>     This do-file cleans the raw Qualtrics SPSS export from the main survey.
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. clear all

. global scriptname "clean_main"

. do "code/_config.do"

. /*===========================================================================
> ===
>     Project Configuration
> 
>     Set the project directory once here; all other scripts include this file.
> 
>     Usage: Include at the top of each do-file:
>         global scriptname "my_script"
>         do "code/_config.do"
> 
>     In batch mode (stata -e), logs to output/logs/{scriptname}.log
>     In interactive mode, no logging occurs.
> 
>     Created by Dan + Claude Code
> =============================================================================
> =*/
. 
. * Settings for both batch and interactive mode
. set more off

. set rmsg off

. 
. * Set project directory based on operating system
. * c(os) returns "Windows" on Windows, "Unix" or "MacOSX" on Mac
. local usr `c(username)'

. if "`c(os)'" == "Windows" {
.     global projdir "C:/Users/`usr'/Projects/VaccSideEffects"
. }

. else {
.     * macOS (Unix or MacOSX)
.     global projdir "/Users/`usr'/Projects/VaccSideEffects"
. }

. cd "$projdir"
C:\Users\dwsacks\Projects\VaccSideEffects

. 
. * Add local ado files to path (for plot_to_csv and other custom programs)
. adopath + "$projdir/code/include"
  [1]  (BASE)      "C:\Program Files\Stata18\ado\base/"
  [2]  (SITE)      "C:\Program Files\Stata18\ado\site/"
  [3]              "."
  [4]  (PERSONAL)  "C:\msys64\home\dwsacks\ado\personal/"
  [5]  (PLUS)      "C:\msys64\home\dwsacks\ado\plus/"
  [6]  (OLDPLACE)  "c:\ado/"
  [7]              "C:/Users/dwsacks/Projects/VaccSideEffects/code/include"

. adopath + "$projdir/code/ado"
  [1]  (BASE)      "C:\Program Files\Stata18\ado\base/"
  [2]  (SITE)      "C:\Program Files\Stata18\ado\site/"
  [3]              "."
  [4]  (PERSONAL)  "C:\msys64\home\dwsacks\ado\personal/"
  [5]  (PLUS)      "C:\msys64\home\dwsacks\ado\plus/"
  [6]  (OLDPLACE)  "c:\ado/"
  [7]              "C:/Users/dwsacks/Projects/VaccSideEffects/code/include"
  [8]              "C:/Users/dwsacks/Projects/VaccSideEffects/code/ado"

. 
. * Create output subdirectories if they don't exist
. capture mkdir "output"

. capture mkdir "output/logs"

. capture mkdir "output/tables"

. capture mkdir "output/docs"

. capture mkdir "output/figures"

. 
. /*---------------------------------------------------------------------------
> ---
>     Named Constants
> 
>     These replace magic numbers scattered throughout the codebase.
> -----------------------------------------------------------------------------
> -*/
. 
. * Attention check expected values (from survey design)
. global ATTN_CHECK_PRESCREEN = 1965

. global ATTN_CHECK_MAIN = 4419

. global ATTN_CHECK_FOLLOWUP = 1163

. 
. * Special code for unselected responses
. global UNSELECTED_VALUE  = -99

. 
. * Special code for "prefer not to say" responses (same as unselected)
. global PREF_NOT_SAY = -99

. 
. /*---------------------------------------------------------------------------
> ---
>     Conditional Logging
> -----------------------------------------------------------------------------
> -*/
. 
. * Only log in batch mode
. if "`c(mode)'" == "batch" & "$scriptname" != "" {
.     capture log close _all
.     log using "output/logs/$scriptname.log", replace text
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\dwsacks\Projects\VaccSideEffects\output/logs/clean_main.l
> og
  log type:  text
 opened on:  29 Jan 2026, 10:36:49
.     di "=== Running in batch mode: $scriptname ==="
=== Running in batch mode: clean_main ===
.     di "Log: output/logs/$scriptname.log"
Log: output/logs/clean_main.log
.     di ""

. }

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     1. Load raw SPSS data
> -----------------------------------------------------------------------------
> -*/
. 
. import spss using "raw_data/flu_survey_main_January+9,+2026_08.08.sav", clear
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
note: invalid string format %16000s
(51 vars, 3,658 obs)

. 
. * Verify we have data
. assert _N > 0

. di "Loaded " _N " observations"
Loaded 3658 observations

. 
. /*---------------------------------------------------------------------------
> ---
>     2. Drop unused metadata variables
> -----------------------------------------------------------------------------
> -*/
. drop RecipientLastName RecipientFirstName RecipientEmail ExternalReference

. 
. /*---------------------------------------------------------------------------
> ---
>     3. Rename variables to clean names
> -----------------------------------------------------------------------------
> -*/
. 
. * Standard Qualtrics metadata renames
. do "code/include/_rename_qualtrics_metadata.do"

. /*===========================================================================
> ===
>     Rename Standard Qualtrics Metadata Variables
> 
>     This include file standardizes the renaming of Qualtrics metadata variabl
> es
>     that are common across all survey exports (prescreen, main, followup).
> 
>     Must be called after import spss and before variable-specific cleaning.
> 
>     Usage: do "code/include/_rename_qualtrics_metadata.do"
> =============================================================================
> =*/
. 
. * Rename Qualtrics metadata to clean names
. rename StartDate start_date

. rename EndDate end_date

. rename Duration__in_seconds_ duration_sec

. rename Finished _finished

. rename ResponseId response_id

. rename IPAddress _ipaddress

. rename LocationLatitude _lat

. rename LocationLongitude _long

. rename Status _status

. rename RecordedDate _recordeddate

. rename DistributionChannel _distchannel

. rename UserLanguage _userlang

. 
. * Rename Progress if it exists (some surveys already have lowercase)
. capture rename Progress progress

. 
end of do-file

. 
. * Rename main survey-specific variables
. rename Q52 prolific_id_entered

. rename Q2 attn_check

. rename PROLIFIC_PID prolific_pid

. 
. /*---------------------------------------------------------------------------
> ---
>     4. Create preview flag from Status
> -----------------------------------------------------------------------------
> -*/
. 
. * Status: 0 = IP Address (real), 1 = Survey Preview
. gen is_preview = (_status == 1) if !mi(_status)

. replace is_preview = 0 if mi(is_preview)
(0 real changes made)

. 
. /*---------------------------------------------------------------------------
> ---
>     5. Define value labels
> -----------------------------------------------------------------------------
> -*/
. 
. do "code/include/_define_value_labels.do"

. /*===========================================================================
> ===
>     Define Common Value Labels
> 
>     This include file defines all value labels used across survey cleaning fi
> les.
>     Centralizes label definitions to ensure consistency and reduce duplicatio
> n.
> 
>     Must be called before variable recoding/labeling.
> 
>     Usage: do "code/include/_define_value_labels.do"
> =============================================================================
> =*/
. 
. * Boolean (Yes/No)
. label define yesno 0 "0. No" 1 "1. Yes", replace

. 
. * Insurance (Yes/No/Not sure) - prescreen only
. label define insurance_lbl -1 "-1. Not sure" 0 "0. No" 1 "1. Yes", replace

. 
. * Likert agreement scale (1-5)
. label define agree5 ///
>     1 "1. Strongly disagree" ///
>     2 "2. Somewhat disagree" ///
>     3 "3. Neither agree nor disagree" ///
>     4 "4. Somewhat agree" ///
>     5 "5. Strongly agree", replace

. 
. * Frequency scale (1-4)
. label define freq4 ///
>     1 "1. Never" ///
>     2 "2. Rarely" ///
>     3 "3. Sometimes" ///
>     4 "4. Often", replace

. 
. * Frequency scale with "no doctor" option
. label define freq4_nodoc ///
>     -1 "-1. No doctor" ///
>     1 "1. Never" ///
>     2 "2. Rarely" ///
>     3 "3. Sometimes" ///
>     4 "4. Often", replace

. 
. * Reliability scale (1-3)
. label define reliable3 ///
>     1 "1. Not reliable" ///
>     2 "2. Somewhat reliable" ///
>     3 "3. Yes, reliable", replace

. 
. * Flu vaccine last year - prescreen
. label define fluvax_lastyear_lbl 0 "0. No" 1 "1. Yes", replace

. 
. * Prior vaccines - prescreen
. label define prior_vax_lbl ///
>     1 "1. Neither vaccine" ///
>     2 "2. Flu only" ///
>     3 "3. COVID only" ///
>     4 "4. Both vaccines", replace

. 
. * Flu vaccine intent - prescreen
. label define flu_intent_lbl ///
>     1 "1. No, do not intend" ///
>     2 "2. May or may not" ///
>     3 "3. Intend to get" ///
>     4 "4. Already got", replace

. 
. * Vaccine reaction - prescreen
. label define reaction_lbl ///
>     0 "0. No prior vaccine" ///
>     1 "1. None/don't remember" ///
>     2 "2. Mild (not severe)" ///
>     3 "3. Severe", replace

. 
. * Main info source - prescreen
. label define source_main_lbl ///
>     1 "1. Doctor" ///
>     2 "2. Social media" ///
>     3 "3. Podcasts" ///
>     4 "4. CDC" ///
>     5 "5. News organizations" ///
>     6 "6. None of the above", replace

. 
. * Treatment arm - main
. label define arm_lbl ///
>     0 "0. Control" ///
>     1 "1. Industry" ///
>     2 "2. Academic" ///
>     3 "3. Personal", replace

. 
. * Prior beliefs (7-point) - main
. label define prior7_lbl ///
>     1 "1. Would definitely not" ///
>     2 "2. Very unlikely" ///
>     3 "3. Somewhat unlikely" ///
>     4 "4. Neither likely nor unlikely" ///
>     5 "5. Somewhat likely" ///
>     6 "6. Very likely" ///
>     7 "7. Would definitely", replace

. 
. * Trust/relevance (0-10) - main
. label define scale10_lbl ///
>     0 "0" 1 "1" 2 "2" 3 "3" 4 "4" 5 "5" 6 "6" 7 "7" 8 "8" 9 "9" 10 "10", repl
> ace

. 
. * Vaccination intentions - main
. label define vacc_intent_lbl ///
>     1 "1. No, do not intend" ///
>     2 "2. May or may not" ///
>     3 "3. Intend to get" ///
>     4 "4. Already got" ///
>     $PREF_NOT_SAY "$PREF_NOT_SAY. Prefer not to say", replace

. 
. * Age - main
. label define age_lbl ///
>     1 "1. Under 18" ///
>     2 "2. 18-34" ///
>     3 "3. 35-49" ///
>     4 "4. 50-64" ///
>     5 "5. 65-74" ///
>     6 "6. 75+" ///
>     $PREF_NOT_SAY "$PREF_NOT_SAY. Prefer not to say", replace

. 
. * Gender - main
. label define gender_lbl ///
>     1 "1. Male" ///
>     2 "2. Female" ///
>     3 "3. Other" ///
>     4 "4. Prefer not to say", replace

. 
. * Education - main
. label define educ_lbl ///
>     1 "1. Less than HS" ///
>     2 "2. HS" ///
>     3 "3. Some college" ///
>     4 "4. 4-year degree" ///
>     5 "5. More than 4-year" ///
>     6 "6. Prefer not to say", replace

. 
. * Income - main
. label define income_lbl ///
>     1 "1. <$25k" ///
>     2 "2. $25-50k" ///
>     3 "3. $50-75k" ///
>     4 "4. $75-100k" ///
>     5 "5. >$100k" ///
>     6 "6. Prefer not to say", replace

. 
. * Race - main
. label define race_lbl ///
>     1 "1. White" ///
>     2 "2. Black" ///
>     3 "3. Asian" ///
>     4 "4. Am Indian/Alaska Native" ///
>     5 "5. Pacific Islander" ///
>     6 "6. Other" ///
>     7 "7. Prefer not to say", replace

. 
. * Ethnicity - main
. label define ethnicity_lbl ///
>     1 "1. Yes" ///
>     2 "2. No" ///
>     3 "3. Prefer not to say", replace

. 
. * Political views - main
. label define polviews_lbl ///
>     1 "1. Very liberal" ///
>     2 "2. Liberal" ///
>     3 "3. Slightly liberal" ///
>     4 "4. Moderate" ///
>     5 "5. Slightly conservative" ///
>     6 "6. Conservative" ///
>     7 "7. Very conservative" ///
>     8 "8. Prefer not to say", replace

. 
. * Pharmacy factor - followup
. label define factor_lbl ///
>     1 "1. Price" ///
>     2 "2. Convenience" ///
>     3 "3. Quality/reputation" ///
>     4 "4. Pharmacist access" ///
>     5 "5. None important", replace

. 
. * Price compare / coupons - followup
. label define shopping_lbl ///
>     1 "1. Yes, at least once" ///
>     2 "2. No" ///
>     3 "3. Did not shop for medicines", replace

. 
. * Recall study - followup
. label define recall_lbl ///
>     1 "1. Yes" ///
>     2 "2. No" ///
>     3 "3. Don't remember", replace

. 
. * Recall info - followup
. label define recallinfo_lbl ///
>     1 "1. Yes" ///
>     2 "2. No" ///
>     3 "3. Don't remember study", replace

. 
. * Trustworthy - followup
. label define trust_lbl ///
>     1 "1. Don't remember study" ///
>     2 "2. Trustworthy" ///
>     3 "3. Somewhat trustworthy" ///
>     4 "4. Not trustworthy", replace

. 
end of do-file

. 
. /*---------------------------------------------------------------------------
> ---
>     6. Convert/clean variables
> -----------------------------------------------------------------------------
> -*/
. 
. * --- Consent (SPSS imports as numeric) ---
. * Check current values
. tab consent, m

 University |
         of |
Wisconsin-M |
adison

Res |
      earch |
participant |
information |
 sheet

You |
        are |      Freq.     Percent        Cum.
------------+-----------------------------------
        Yes |      3,655       99.92       99.92
         No |          3        0.08      100.00
------------+-----------------------------------
      Total |      3,658      100.00

. * SPSS has 4=Yes, 5=No - recode to 1/0
. recode consent (4=1) (5=0)
(3,658 changes made to consent)

. label values consent yesno

. 
. * --- Attention check ---
. destring attn_check, replace force
attn_check: contains nonnumeric characters; replaced as long
(12 missing values generated)

. 
. * --- Prior beliefs (already numeric from SPSS) ---
. label values prior_self_placebo prior7_lbl

. label values prior_self_vacc prior7_lbl

. 
. * --- Trust/relevance (SPSS has 1-11, convert to 0-10 scale) ---
. foreach v of varlist trust_trial relevant_trial trust_academic relevant_acade
> mic {
  2.         sum `v'
  3.         assert r(max) == 11 & r(min)==1
  4.         replace `v' = `v' - 1 if !mi(`v')
  5. }

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 trust_trial |      3,561    6.445381    2.438665          1         11
(3,561 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
relevant_t~l |      3,561           6    3.029073          1         11
(3,561 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
trust_acad~c |      1,780    6.874719    2.373389          1         11
(1,780 real changes made)

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
relevant_a~c |      1,780    5.897753    3.061978          1         11
(1,780 real changes made)

. label values trust_trial scale10_lbl

. label values relevant_trial scale10_lbl

. label values trust_academic scale10_lbl

. label values relevant_academic scale10_lbl

. 
. * --- Vaccination intentions (already numeric from SPSS) ---
. label values vacc_intentions vacc_intent_lbl

. 
. * --- Demographics (already numeric from SPSS) ---
. label values age age_lbl

. label values gender gender_lbl

. label values education educ_lbl

. label values income income_lbl

. label values race race_lbl

. label values ethnicity ethnicity_lbl

. label values polviews polviews_lbl

. 
. 
. * --- Link clicks ---
. foreach i of numlist 1/4 {
  2.         destring link`i'_clicked, replace
  3. }
link1_clicked: all characters numeric; replaced as byte
link2_clicked: all characters numeric; replaced as byte
link3_clicked: all characters numeric; replaced as byte
link4_clicked: all characters numeric; replaced as byte

. 
. /*---------------------------------------------------------------------------
> ---
>     7. Consolidate treatment arm variables
> -----------------------------------------------------------------------------
> -*/
. 
. * Treatment arm is stored in FL_17_DO_* variables (1 if assigned to that arm)
. gen arm_n = .
(3,658 missing values generated)

. replace arm_n = 0 if FL_17_DO_CONTROLARM == 1
(900 real changes made)

. replace arm_n = 1 if FL_17_DO_INDUSTRYARM == 1
(899 real changes made)

. replace arm_n = 2 if FL_17_DO_ACADEMICARM == 1
(899 real changes made)

. replace arm_n = 3 if FL_17_DO_PERSONALARM == 1
(899 real changes made)

. label values arm_n arm_lbl

. label var arm_n "Treatment arm (numeric)"

. 
. * Check arm assignment
. count if mi(arm_n) & consent == 1 & _distchannel == "anonymous" & ///
>         attn_check == $ATTN_CHECK_MAIN
  42

.         
. di "Consented anonymous without arm assignment: " r(N)
Consented anonymous without arm assignment: 42

. 
. * Create string arm indicator
. gen arm = ""
(3,658 missing values generated)

. replace arm = "control" if arm_n == 0
variable arm was str1 now str7
(900 real changes made)

. replace arm = "industry" if arm_n == 1
variable arm was str7 now str8
(899 real changes made)

. replace arm = "academic" if arm_n == 2
(899 real changes made)

. replace arm = "personal" if arm_n == 3
(899 real changes made)

. label var arm "Treatment arm (string)"

. 
. * Create arm dummies
. local arms "control industry academic personal"

. local i = 0

. foreach a of local arms {
  2.     gen arm_`a' = (arm_n == `i') if !mi(arm_n)
  3.     label var arm_`a' "Treatment: `a' arm"
  4.     label values arm_`a' yesno
  5.     local ++i
  6. }
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)

. 
. /*---------------------------------------------------------------------------
> ---
>     8. Consolidate post-trial and posterior belief variables
> -----------------------------------------------------------------------------
> -*/
. 
. * --- Consolidate post-trial estimate ---
. * Clean text responses: remove % symbols and spaces from SPSS text fields
. 
. foreach a in c i a p {
  2.                 * remove white space and  %
.                 replace post_`a'_trial = ustrregexra(post_`a'_trial, "\s", ""
> )
  3.     replace post_`a'_trial = subinstr(post_`a'_trial, "%", "", .)
  4.                 assert post_`a'_trial == ",7" if missing(real(post_`a'_tri
> al)) & ~missing(post_`a'_trial)
  5.     destring post_`a'_trial, replace force
  6. }
(0 real changes made)
(14 real changes made)
(null assertion)
post_c_trial: all characters numeric; replaced as double
(2763 missing values generated)
(1 real change made)
(18 real changes made)
(null assertion)
post_i_trial: all characters numeric; replaced as double
(2765 missing values generated)
(0 real changes made)
(15 real changes made)
(null assertion)
post_a_trial: all characters numeric; replaced as double
(2764 missing values generated)
(1 real change made)
(16 real changes made)
post_p_trial: contains nonnumeric characters; replaced as double
(2763 missing values generated)

. 
. gen post_trial = .
(3,658 missing values generated)

. foreach a in c i a p {
  2.     replace post_trial = post_`a'_trial if !mi(post_`a'_trial)
  3. }
(895 real changes made)
(893 real changes made)
(894 real changes made)
(895 real changes made)

. label var post_trial "Post-trial side effect estimate (0-100)"

. 
. * --- Consolidate posterior beliefs ---
. * Remove "%" if present and convert to numeric
. foreach v in posterior_novacc posterior_vacc {
  2.     capture confirm string variable `v'
  3.     if !_rc {
  4.         replace `v' = subinstr(`v', "%", "", .)
  5.         destring `v', replace
  6.     }
  7. }
(37 real changes made)
posterior_novacc: all characters numeric; replaced as double
(85 missing values generated)
(36 real changes made)
posterior_vacc: all characters numeric; replaced as double
(92 missing values generated)

. 
. label var posterior_novacc "Posterior: SE probability without vaccine (0-100)
> "

. label var posterior_vacc "Posterior: SE probability with vaccine (0-100)"

. 
. /*---------------------------------------------------------------------------
> ---
>     9. Create derived variables
> -----------------------------------------------------------------------------
> -*/
. 
. * Delta: difference between posterior with vaccine and without vaccine
. gen delta = posterior_vacc - posterior_novacc
(92 missing values generated)

. label var delta "Posterior difference (vacc - novacc)"

. 
. * Maybe: binary indicator for vaccine intention (intend to or already got)
. gen maybe = inlist(vacc_intentions, 3, 4) if !mi(vacc_intentions)
(100 missing values generated)

. label var maybe "Intends/already got vaccine"

. label values maybe yesno

. 
. * Link click: any link clicked
. gen link_click = (link1_clicked == 1 | link2_clicked == 1 | link3_clicked == 
> 1 | link4_clicked == 1)

. label var link_click "Any link clicked"

. label values link_click yesno

. 
. 
. /*---------------------------------------------------------------------------
> ---
>     10. Create quality/sample flags
> -----------------------------------------------------------------------------
> -*/
. 
. * Set attention check parameters for this survey
. global attn_check_var "attn_check"

. global attn_check_val = $ATTN_CHECK_MAIN

. 
. do "code/include/_create_quality_flags.do"

. /*===========================================================================
> ===
>     Create Quality/Sample Flags
> 
>     This include file creates standard quality and sample flags used across
>     all survey cleaning files. It requires the following globals to be set:
> 
>     - $attn_check_var: Name of attention check variable (e.g., favorite_numbe
> r, attn_check)
>     - $attn_check_val: Expected value for attention check (e.g., 1965, 4419, 
> 1163)
> 
>     It also requires the following variables to exist:
>     - progress: Survey progress (0-100)
>     - _finished: Finished flag from Qualtrics
>     - prolific_pid: Prolific ID from URL
>     - prolific_id_entered: Prolific ID entered by respondent
>     - _distchannel: Distribution channel from Qualtrics
>     - is_preview: Preview flag (created earlier)
>     - start_date: Survey start date
> 
>     Usage:
>         global attn_check_var "favorite_number"
>         global attn_check_val = $ATTN_CHECK_PRESCREEN
>         do "code/include/_create_quality_flags.do"
> =============================================================================
> =*/
. 
. * Incomplete flag
. gen incomplete = (progress != 100 | _finished != 1)

. label var incomplete "Incomplete response"

. 
. * Failed attention check
. * Attention check value from survey (set via $attn_check_val global)
. * Use ${} syntax to expand macro as variable name
. gen failed_attn = (${attn_check_var} != $attn_check_val) if !mi(${attn_check_
> var})
(12 missing values generated)

. replace failed_attn = 1 if mi(${attn_check_var})
(12 real changes made)

. label var failed_attn "Failed attention check"

. 
. * PID mismatch
. gen pid_mismatch = (prolific_pid != prolific_id_entered)

. label var pid_mismatch "Prolific PID mismatch"

. 
. * Flag first attempt per PID (sort by start_date, keep first)
. bysort prolific_pid (start_date): gen first_attempt = (_n == 1)

. label var first_attempt "First survey attempt for this PID"

. 
. * Duplicate PID (for reference/reporting only)
. duplicates tag prolific_pid, gen(duplicate_pid)

Duplicates in terms of prolific_pid

. replace duplicate_pid = (duplicate_pid > 0)
(7 real changes made)

. label var duplicate_pid "Duplicate Prolific PID"

. 
end of do-file

. 
. * Count missing outcomes
. egen n_missing = rowmiss(posterior_vacc posterior_novacc post_trial)

. 
. * Final sample flag (main survey requires non-missing outcomes)
. gen final_sample = (consent == 1 & failed_attn == 0 ///
>     & _distchannel == "anonymous" & is_preview == 0 ///
>                 & n_missing == 0 & first_attempt == 1)

. 
. label var final_sample "Final analysis sample (consent, passed attn, non-miss
> ing outcomes, first attempt)"
note: label truncated to 80 characters

. assert ~missing(arm_n) if final_sample

. 
. /*---------------------------------------------------------------------------
> ---
>     11. Apply variable labels
> -----------------------------------------------------------------------------
> -*/
. 
. label var start_date "Survey start date/time"

. label var end_date "Survey end date/time"

. label var duration_sec "Survey duration (seconds)"

. label var progress "Survey progress (%)"

. label var response_id "Qualtrics response ID"

. label var consent "Consent given"

. label var prolific_id_entered "Prolific ID (entered)"

. label var prolific_pid "Prolific ID (from URL)"

. label var attn_check "Attention check value (should be $ATTN_CHECK_MAIN)"

. label var prior_self_placebo "Prior belief: SE likelihood without vaccine (1-
> 7)"

. label var prior_self_vacc "Prior belief: SE likelihood with vaccine (1-7)"

. label var post_c_trial "Post-trial estimate: Control arm"

. label var post_i_trial "Post-trial estimate: Industry arm"

. label var post_a_trial "Post-trial estimate: Academic arm"

. label var post_p_trial "Post-trial estimate: Personal arm"

. label var trust_trial "Trust in trial information (0-10)"

. label var relevant_trial "Relevance of trial information (0-10)"

. label var trust_academic "Trust in academic source (0-10)"

. label var relevant_academic "Relevance of academic source (0-10)"

. label var vacc_intentions "Flu vaccine intentions"

. label var age "Age group"

. label var gender "Gender"

. label var education "Education level"

. label var income "Household income"

. label var race "Race"

. label var ethnicity "Hispanic/Latino"

. label var polviews "Political views"

. label var debrief_about "Debrief: What survey was about"

. label var comments "Final comments"

. label var link1_clicked "Link 1 clicked"

. label var link2_clicked "Link 2 clicked"

. label var link3_clicked "Link 3 clicked"

. label var link4_clicked "Link 4 clicked"

. 
. * Label all yes/no variables
. foreach var of varlist final_sample incomplete failed_attn pid_mismatch dupli
> cate_pid first_attempt is_preview ///
>     arm_control arm_industry arm_academic arm_personal maybe link_click {
  2.     label values `var' yesno
  3. }

. 
. /*---------------------------------------------------------------------------
> ---
>     12. Create balance table indicator variables
> -----------------------------------------------------------------------------
> -*/
. 
. * --- Prior Beliefs (7-point scales) ---
. * prior_self_placebo: SE likelihood without vaccine
. forvalues i = 1/7 {
  2.     gen prior_placebo_`i' = (prior_self_placebo == `i') if ~missing(prior_
> self_placebo)
  3. }
(50 missing values generated)
(50 missing values generated)
(50 missing values generated)
(50 missing values generated)
(50 missing values generated)
(50 missing values generated)
(50 missing values generated)

. label var prior_placebo_1 "Prior placebo: Would definitely not"

. label var prior_placebo_2 "Prior placebo: Very unlikely"

. label var prior_placebo_3 "Prior placebo: Somewhat unlikely"

. label var prior_placebo_4 "Prior placebo: Neither"

. label var prior_placebo_5 "Prior placebo: Somewhat likely"

. label var prior_placebo_6 "Prior placebo: Very likely"

. label var prior_placebo_7 "Prior placebo: Would definitely"

. 
. * prior_self_vacc: SE likelihood with vaccine
. forvalues i = 1/7 {
  2.     gen prior_vacc_`i' = (prior_self_vacc == `i') if ~missing(prior_self_v
> acc)
  3. }
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)
(61 missing values generated)

. label var prior_vacc_1 "Prior vacc: Would definitely not"

. label var prior_vacc_2 "Prior vacc: Very unlikely"

. label var prior_vacc_3 "Prior vacc: Somewhat unlikely"

. label var prior_vacc_4 "Prior vacc: Neither"

. label var prior_vacc_5 "Prior vacc: Somewhat likely"

. label var prior_vacc_6 "Prior vacc: Very likely"

. label var prior_vacc_7 "Prior vacc: Would definitely"

. 
. * --- Demographics ---
. * Create missing indicators and impute missing values to avoid dropping obser
> vations
. * in regressions. The missing indicator captures any systematic missingness e
> ffect.
. * Treat both Stata-missing and PREF_NOT_SAY (-99) as missing.
. * Note: trust_govt is from prescreen, handled in merge step
. foreach var in age gender education income race ethnicity polviews {
  2.     gen `var'_miss = (missing(`var') | `var' == $PREF_NOT_SAY)
  3.     label var `var'_miss "`var' missing"
  4.     * Impute missing/PREF_NOT_SAY to base category (will be absorbed by fa
> ctor variable)
.     replace `var' = 1 if missing(`var') | `var' == $PREF_NOT_SAY
  5. }
(101 real changes made)
(100 real changes made)
(100 real changes made)
(100 real changes made)
(100 real changes made)
(100 real changes made)
(100 real changes made)

. 
. * Age (2=18-34, 3=35-49, 4=50-64, 5=65+)
. gen age_18_34 = (age == 2) if ~missing(age)

. gen age_35_49 = (age == 3) if ~missing(age)

. gen age_50_64 = (age == 4) if ~missing(age)

. gen age_65plus = (age == 5) if ~missing(age)

. 
. label var age_18_34 "Age 18--34"

. label var age_35_49 "Age 35--49"

. label var age_50_64 "Age 50--64"

. label var age_65plus "Age 65+"

. 
. * Gender (1=Male, 2=Female, 3=Other)
. gen female = (gender == 2) if ~missing(gender)

. gen gender_other = (gender == 3) if ~missing(gender)

. 
. label var female "Female"

. label var gender_other "Gender: Other"

. 
. * Education (1=<HS, 2=HS, 3=Some college, 4=4-year, 5=>4-year)
. gen educ_hs_or_less = (education <= 2) if ~missing(education)

. gen educ_some_college = (education == 3) if ~missing(education)

. gen educ_college = (education == 4) if ~missing(education)

. gen educ_grad = (education == 5) if ~missing(education)

. 
. label var educ_hs_or_less "Education: HS or less"

. label var educ_some_college "Education: Some college"

. label var educ_college "Education: 4-year degree"

. label var educ_grad "Education: Graduate degree"

. 
. * Income (1=<25k, 2=25-50k, 3=50-75k, 4=75-100k, 5=>100k)
. gen income_lt25k = (income == 1) if ~missing(income)

. gen income_25_50k = (income == 2) if ~missing(income)

. gen income_50_75k = (income == 3) if ~missing(income)

. gen income_75_100k = (income == 4) if ~missing(income)

. gen income_100kplus = (income == 5) if ~missing(income)

. 
. label var income_lt25k "Income: Under \$25k"

. label var income_25_50k "Income: \$25--50k"

. label var income_50_75k "Income: \$50--75k"

. label var income_75_100k "Income: \$75--100k"

. label var income_100kplus "Income: Over \$100k"

. 
. * Race (1=White, 2=Black, 3=Asian, 4=Am Indian, 5=Other)
. gen race_white = (race == 1) if ~missing(race)

. gen race_black = (race == 2) if ~missing(race)

. gen race_asian = (race == 3) if ~missing(race)

. gen race_native = (race == 4) if ~missing(race)

. gen race_other = (race == 5) if ~missing(race)

. 
. label var race_white "White"

. label var race_black "Black"

. label var race_asian "Asian"

. label var race_native "American Indian/Alaska Native"

. label var race_other "Race: Other"

. 
. * Ethnicity (1=Hispanic)
. gen hispanic = (ethnicity == 1) if ~missing(ethnicity)

. 
. label var hispanic "Hispanic"

. 
. * Political views (1-7)
. gen polviews_very_liberal = (polviews == 1) if ~missing(polviews)

. gen polviews_liberal = (polviews == 2) if ~missing(polviews)

. gen polviews_slight_liberal = (polviews == 3) if ~missing(polviews)

. gen polviews_moderate = (polviews == 4) if ~missing(polviews)

. gen polviews_slight_conserv = (polviews == 5) if ~missing(polviews)

. gen polviews_conservative = (polviews == 6) if ~missing(polviews)

. gen polviews_very_conserv = (polviews == 7) if ~missing(polviews)

. 
. label var polviews_very_liberal "Very liberal"

. label var polviews_liberal "Liberal"

. label var polviews_slight_liberal "Slightly liberal"

. label var polviews_moderate "Moderate"

. label var polviews_slight_conserv "Slightly conservative"

. label var polviews_conservative "Conservative"

. label var polviews_very_conserv "Very conservative"

. 
. /*---------------------------------------------------------------------------
> ---
>     13. Drop unnecessary variables and reorder
> -----------------------------------------------------------------------------
> -*/
. 
. * Drop temporary variables
. drop _ipaddress _lat _long _status _finished _recordeddate _distchannel _user
> lang

. drop FL_17_DO_CONTROLARM FL_17_DO_INDUSTRYARM FL_17_DO_ACADEMICARM FL_17_DO_P
> ERSONALARM

. 
. * Note: Progress already renamed to progress by _rename_qualtrics_metadata.do
. 
. * Order variables logically
. order response_id prolific_pid prolific_id_entered ///
>       start_date end_date duration_sec progress ///
>       consent final_sample incomplete failed_attn pid_mismatch duplicate_pid 
> first_attempt is_preview ///
>       attn_check ///
>       arm_n arm arm_control arm_industry arm_academic arm_personal ///
>       prior_self_placebo prior_self_vacc  ///
>       post_trial post_c_trial post_i_trial post_a_trial post_p_trial ///
>       posterior_novacc posterior_vacc delta ///
>       trust_trial relevant_trial trust_academic relevant_academic ///
>       vacc_intentions maybe ///
>       link_click link1_clicked link2_clicked link3_clicked link4_clicked ///
>       age gender education income race ethnicity polviews ///
>       debrief_about comments

. rename vacc_intentions vacc_intent

. 
. /*---------------------------------------------------------------------------
> ---
>     13. Final assertions and save
> -----------------------------------------------------------------------------
> -*/
. 
. * Verify key variable ranges
. assert inlist(consent, 0, 1, .)

. assert inlist(arm_n, 0, 1, 2, 3, .)

. assert inlist(prior_self_placebo, 1, 2, 3, 4, 5, 6, 7, .)

. assert inlist(prior_self_vacc, 1, 2, 3, 4, 5, 6, 7, .)

. assert post_trial >= 0 & post_trial <= 100 if !mi(post_trial)

. assert posterior_novacc >= 0 & posterior_novacc <= 100 if !mi(posterior_novac
> c)

. assert posterior_vacc >= 0 & posterior_vacc <= 100 if !mi(posterior_vacc)

. assert inlist(trust_trial, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, .)

. assert inlist(relevant_trial, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, .)

. assert inlist(vacc_intent, 1, 2, 3, 4, $PREF_NOT_SAY, .)

. assert inlist(age, 1, 2, 3, 4, 5, 6, .)  // PREF_NOT_SAY recoded to 1

. assert inlist(gender, 1, 2, 3, 4, .)

. assert inlist(education, 1, 2, 3, 4, 5, 6, .)

. assert inlist(income, 1, 2, 3, 4, 5, 6, .)

. assert inlist(race, 1, 2, 3, 4, 5, 6, 7, .)

. assert inlist(ethnicity, 1, 2, 3, .)

. assert inlist(polviews, 1, 2, 3, 4, 5, 6, 7, 8, .)

. 
. * Check variable count
. desc

Contains data
 Observations:         3,658                  
    Variables:           102                  
-------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
-------------------------------------------------------------------------------
response_id     str17   %17s                  Qualtrics response ID
prolific_pid    str24   %24s                  Prolific ID (from URL)
prolific_id_e~d str67   %67s                  Prolific ID (entered)
start_date      double  %tc..                 Survey start date/time
end_date        double  %tc..                 Survey end date/time
duration_sec    long    %40.2f                Survey duration (seconds)
progress        byte    %40.2f                Survey progress (%)
consent         byte    %40.0f     yesno      Consent given
final_sample    double  %10.0g     yesno      Final analysis sample (consent,
                                                passed attn, non-missing
                                                outcomes, first attempt
incomplete      double  %10.0g     yesno      Incomplete response
failed_attn     double  %10.0g     yesno      Failed attention check
pid_mismatch    double  %10.0g     yesno      Prolific PID mismatch
duplicate_pid   byte    %12.0g     yesno      Duplicate Prolific PID
first_attempt   double  %10.0g     yesno      First survey attempt for this PID
is_preview      double  %10.0g     yesno      
attn_check      long    %10.0g                Attention check value (should be
                                                4419)
arm_n           double  %11.0g     arm_lbl    Treatment arm (numeric)
arm             str8    %9s                   Treatment arm (string)
arm_control     double  %10.0g     yesno      Treatment: control arm
arm_industry    double  %10.0g     yesno      Treatment: industry arm
arm_academic    double  %10.0g     yesno      Treatment: academic arm
arm_personal    double  %10.0g     yesno      Treatment: personal arm
prior_self_pl~o byte    %40.0f     prior7_lbl
                                              Prior belief: SE likelihood
                                                without vaccine (1-7)
prior_self_vacc byte    %40.0f     prior7_lbl
                                              Prior belief: SE likelihood with
                                                vaccine (1-7)
post_trial      double  %10.0g                Post-trial side effect estimate
                                                (0-100)
post_c_trial    double  %10.0g                Post-trial estimate: Control arm
post_i_trial    double  %10.0g                Post-trial estimate: Industry arm
post_a_trial    double  %10.0g                Post-trial estimate: Academic arm
post_p_trial    double  %10.0g                Post-trial estimate: Personal arm
posterior_nov~c double  %10.0g                Posterior: SE probability without
                                                vaccine (0-100)
posterior_vacc  double  %10.0g                Posterior: SE probability with
                                                vaccine (0-100)
delta           double  %10.0g                Posterior difference (vacc -
                                                novacc)
trust_trial     byte    %40.0f     scale10_lbl
                                              Trust in trial information (0-10)
relevant_trial  byte    %40.0f     scale10_lbl
                                              Relevance of trial information
                                                (0-10)
trust_academic  byte    %40.0f     scale10_lbl
                                              Trust in academic source (0-10)
relevant_acad~c byte    %40.0f     scale10_lbl
                                              Relevance of academic source
                                                (0-10)
vacc_intent     byte    %40.0f     vacc_intent_lbl
                                              Flu vaccine intentions
maybe           double  %10.0g     yesno      Intends/already got vaccine
link_click      double  %10.0g     yesno      Any link clicked
link1_clicked   byte    %10.0g                Link 1 clicked
link2_clicked   byte    %10.0g                Link 2 clicked
link3_clicked   byte    %10.0g                Link 3 clicked
link4_clicked   byte    %10.0g                Link 4 clicked
age             byte    %40.0f     age_lbl    Age group
gender          byte    %40.0f     gender_lbl
                                              Gender
education       byte    %40.0f     educ_lbl   Education level
income          byte    %40.0f     income_lbl
                                              Household income
race            byte    %40.0f     race_lbl   Race
ethnicity       byte    %40.0f     ethnicity_lbl
                                              Hispanic/Latino
polviews        byte    %40.0f     polviews_lbl
                                              Political views
debrief_about   strL    %%2                   Debrief: What survey was about
comments        strL    %%2                   Final comments
n_missing       double  %10.0g                
prior_placebo_1 double  %10.0g                Prior placebo: Would definitely
                                                not
prior_placebo_2 double  %10.0g                Prior placebo: Very unlikely
prior_placebo_3 double  %10.0g                Prior placebo: Somewhat unlikely
prior_placebo_4 double  %10.0g                Prior placebo: Neither
prior_placebo_5 double  %10.0g                Prior placebo: Somewhat likely
prior_placebo_6 double  %10.0g                Prior placebo: Very likely
prior_placebo_7 double  %10.0g                Prior placebo: Would definitely
prior_vacc_1    double  %10.0g                Prior vacc: Would definitely not
prior_vacc_2    double  %10.0g                Prior vacc: Very unlikely
prior_vacc_3    double  %10.0g                Prior vacc: Somewhat unlikely
prior_vacc_4    double  %10.0g                Prior vacc: Neither
prior_vacc_5    double  %10.0g                Prior vacc: Somewhat likely
prior_vacc_6    double  %10.0g                Prior vacc: Very likely
prior_vacc_7    double  %10.0g                Prior vacc: Would definitely
age_miss        double  %10.0g                age missing
gender_miss     double  %10.0g                gender missing
education_miss  double  %10.0g                education missing
income_miss     double  %10.0g                income missing
race_miss       double  %10.0g                race missing
ethnicity_miss  double  %10.0g                ethnicity missing
polviews_miss   double  %10.0g                polviews missing
age_18_34       double  %10.0g                Age 18--34
age_35_49       double  %10.0g                Age 35--49
age_50_64       double  %10.0g                Age 50--64
age_65plus      double  %10.0g                Age 65+
female          double  %10.0g                Female
gender_other    double  %10.0g                Gender: Other
educ_hs_or_less double  %10.0g                Education: HS or less
educ_some_col~e double  %10.0g                Education: Some college
educ_college    double  %10.0g                Education: 4-year degree
educ_grad       double  %10.0g                Education: Graduate degree
income_lt25k    double  %10.0g                Income: Under $25k
income_25_50k   double  %10.0g                Income: $25--50k
income_50_75k   double  %10.0g                Income: $50--75k
income_75_100k  double  %10.0g                Income: $75--100k
income_100kplus double  %10.0g                Income: Over $100k
race_white      double  %10.0g                White
race_black      double  %10.0g                Black
race_asian      double  %10.0g                Asian
race_native     double  %10.0g                American Indian/Alaska Native
race_other      double  %10.0g                Race: Other
hispanic        double  %10.0g                Hispanic
polviews_very~l double  %10.0g                Very liberal
polviews_libe~l double  %10.0g                Liberal
polviews_slig~l double  %10.0g                Slightly liberal
polviews_mode~e double  %10.0g                Moderate
polviews_slig~v double  %10.0g                Slightly conservative
polviews_cons~e double  %10.0g                Conservative
polviews_very~v double  %10.0g                Very conservative
-------------------------------------------------------------------------------
Sorted by: prolific_pid  start_date
     Note: Dataset has changed since last saved.

. local nvars = r(k)

. di "Total variables: `nvars'"
Total variables: 102

. 
. * Final quality summary
. do "code/include/_report_sample_quality.do"

. /*===========================================================================
> ===
>     Report Sample Quality Flags
> 
>     This include file provides standardized quality reporting for all surveys
> .
>     Requires the following variables to exist:
>     - final_sample, incomplete, failed_attn, pid_mismatch, duplicate_pid, is_
> preview
> 
>     Usage: do "code/include/_report_sample_quality.do"
> =============================================================================
> =*/
. 
. di ""


. di "=== QUALITY FLAG SUMMARY ==="
=== QUALITY FLAG SUMMARY ===

. count
  3,658

. di "Total observations: " r(N)
Total observations: 3658

. count if final_sample == 1
  3,538

. di "Final sample: " r(N)
Final sample: 3538

. count if incomplete == 1
  74

. di "Incomplete: " r(N)
Incomplete: 74

. count if failed_attn == 1
  19

. di "Failed attention check: " r(N)
Failed attention check: 19

. count if pid_mismatch == 1
  9

. di "PID mismatch: " r(N)
PID mismatch: 9

. count if duplicate_pid == 1
  57

. di "Duplicate PIDs: " r(N)
Duplicate PIDs: 57

. count if is_preview == 1
  7

. di "Preview responses: " r(N)
Preview responses: 7

. 
end of do-file

. 
. * Compress and save
. compress
  variable final_sample was double now byte
  variable incomplete was double now byte
  variable failed_attn was double now byte
  variable pid_mismatch was double now byte
  variable first_attempt was double now byte
  variable is_preview was double now byte
  variable arm_n was double now byte
  variable arm_control was double now byte
  variable arm_industry was double now byte
  variable arm_academic was double now byte
  variable arm_personal was double now byte
  variable maybe was double now byte
  variable link_click was double now byte
  variable n_missing was double now byte
  variable prior_placebo_1 was double now byte
  variable prior_placebo_2 was double now byte
  variable prior_placebo_3 was double now byte
  variable prior_placebo_4 was double now byte
  variable prior_placebo_5 was double now byte
  variable prior_placebo_6 was double now byte
  variable prior_placebo_7 was double now byte
  variable prior_vacc_1 was double now byte
  variable prior_vacc_2 was double now byte
  variable prior_vacc_3 was double now byte
  variable prior_vacc_4 was double now byte
  variable prior_vacc_5 was double now byte
  variable prior_vacc_6 was double now byte
  variable prior_vacc_7 was double now byte
  variable age_miss was double now byte
  variable gender_miss was double now byte
  variable education_miss was double now byte
  variable income_miss was double now byte
  variable race_miss was double now byte
  variable ethnicity_miss was double now byte
  variable polviews_miss was double now byte
  variable age_18_34 was double now byte
  variable age_35_49 was double now byte
  variable age_50_64 was double now byte
  variable age_65plus was double now byte
  variable female was double now byte
  variable gender_other was double now byte
  variable educ_hs_or_less was double now byte
  variable educ_some_college was double now byte
  variable educ_college was double now byte
  variable educ_grad was double now byte
  variable income_lt25k was double now byte
  variable income_25_50k was double now byte
  variable income_50_75k was double now byte
  variable income_75_100k was double now byte
  variable income_100kplus was double now byte
  variable race_white was double now byte
  variable race_black was double now byte
  variable race_asian was double now byte
  variable race_native was double now byte
  variable race_other was double now byte
  variable hispanic was double now byte
  variable polviews_very_liberal was double now byte
  variable polviews_liberal was double now byte
  variable polviews_slight_liberal was double now byte
  variable polviews_moderate was double now byte
  variable polviews_slight_conserv was double now byte
  variable polviews_conservative was double now byte
  variable polviews_very_conserv was double now byte
  (1,613,178 bytes saved)

. save "derived/main_clean.dta", replace
file derived/main_clean.dta saved

. 
. di ""


. di "=== CLEANING COMPLETE ==="
=== CLEANING COMPLETE ===

. di "Saved: derived/main_clean.dta"
Saved: derived/main_clean.dta

. 
. capture log close

. 
end of do-file
